<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capbit Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }

        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
        }

        h1 { font-size: 1.5rem; font-weight: 700; }
        h1 span { color: var(--primary); }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected { background: var(--success); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-row.stack { flex-direction: column; }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        select, input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.625rem;
            color: var(--text);
            font-size: 0.875rem;
            width: 100%;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        .btn.danger { background: var(--danger); }
        .btn.success { background: var(--success); }
        .btn.warning { background: var(--warning); }
        .btn.outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn.full { width: 100%; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-group .btn { flex: 1; }

        /* Log */
        .log {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.7rem;
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
            word-break: break-all;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--primary); }
        .log-entry.request { color: var(--warning); }
        .log-entry .time { color: var(--text-muted); margin-right: 0.5rem; }
        .log-entry .method {
            background: var(--bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }

        /* Result box */
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .result.allowed { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); }
        .result.denied { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); }

        .result-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .result-text { font-weight: 600; font-size: 1rem; }
        .result-detail { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-input);
            border-radius: 6px;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .chip .type { color: var(--primary); font-weight: 600; }
        .chip.user .type { color: #22c55e; }
        .chip.team .type { color: #f59e0b; }
        .chip.app .type { color: #ec4899; }
        .chip.resource .type { color: #06b6d4; }

        /* Lists */
        .list { display: flex; flex-direction: column; gap: 0.5rem; }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8125rem;
            flex-wrap: wrap;
        }

        .list-item .arrow { color: var(--text-muted); }

        .relation-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .cap-badge {
            font-family: monospace;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Config panel */
        .config-panel {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-row input {
            flex: 1;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <h1>Cap<span>bit</span></h1>
        <div class="status-bar">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </header>

    <div class="container">
        <!-- Server Config -->
        <div class="card">
            <div class="card-title">Server Connection</div>
            <div class="config-row">
                <input type="text" id="api-url" value="http://localhost:3000" placeholder="API URL">
                <button class="btn sm" onclick="checkConnection()">Connect</button>
            </div>
        </div>

        <!-- Activity Log - Always visible -->
        <div class="card">
            <div class="card-title">
                Activity Log
                <div style="display: flex; gap: 0.25rem;">
                    <button class="btn sm outline" onclick="copyLogs()">Copy</button>
                    <button class="btn sm outline" onclick="clearLog()">Clear</button>
                </div>
            </div>
            <div class="log" id="log"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">Setup</button>
            <button class="tab" onclick="showTab('entities')">Entities</button>
            <button class="tab" onclick="showTab('grants')">Grants</button>
            <button class="tab" onclick="showTab('caps')">Caps</button>
            <button class="tab" onclick="showTab('test')">Test</button>
        </div>

        <!-- Setup Tab -->
        <div id="tab-setup" class="tab-content active">
            <div class="card">
                <div class="card-title">Bootstrap System</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Root User ID</label>
                        <input type="text" id="bootstrap-root" value="root" placeholder="e.g. root, admin">
                    </div>
                </div>
                <button class="btn full" onclick="doBootstrap()">Bootstrap</button>
            </div>

            <div class="card">
                <div class="card-title">Quick Setup Templates</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Run a template to populate the system. Watch the log to see each API call.
                </p>
                <div class="btn-group">
                    <button class="btn warning" onclick="runTemplate('startup')">Startup</button>
                    <button class="btn warning" onclick="runTemplate('saas')">SaaS</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Danger Zone</div>
                <button class="btn danger full" onclick="doReset()">Reset Database</button>
            </div>
        </div>

        <!-- Entities Tab -->
        <div id="tab-entities" class="tab-content">
            <div class="card">
                <div class="card-title">Create Entity</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type</label>
                        <select id="entity-type">
                            <option value="user">user</option>
                            <option value="team">team</option>
                            <option value="app">app</option>
                            <option value="resource">resource</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ID</label>
                        <input type="text" id="entity-id" placeholder="e.g. alice, engineering">
                    </div>
                </div>
                <div class="input-group">
                    <label>Actor (who's creating)</label>
                    <input type="text" id="entity-actor" value="user:root" placeholder="e.g. user:root">
                </div>
                <button class="btn full" onclick="doCreateEntity()">Create Entity</button>
            </div>

            <div class="card">
                <div class="card-title">Known Entities</div>
                <div class="list" id="entity-list">
                    <div class="empty">
                        <div class="empty-icon">ðŸ“‹</div>
                        <p>Entities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grants Tab -->
        <div id="tab-grants" class="tab-content">
            <div class="card">
                <div class="card-title">Create Grant</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's granting - must have GRANT_WRITE)</label>
                        <input type="text" id="grant-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="input-group">
                        <label>Seeker (who receives the grant)</label>
                        <input type="text" id="grant-seeker" placeholder="e.g. user:alice">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="grant-relation" placeholder="e.g. lead, member, editor">
                        </div>
                        <div class="input-group">
                            <label>Scope (on what)</label>
                            <input type="text" id="grant-scope" placeholder="e.g. team:engineering">
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateGrant()">Create Grant</button>
            </div>

            <div class="card">
                <div class="card-title">Known Grants</div>
                <div class="list" id="grant-list">
                    <div class="empty">
                        <div class="empty-icon">ðŸ”—</div>
                        <p>Grants tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capabilities Tab -->
        <div id="tab-caps" class="tab-content">
            <div class="card">
                <div class="card-title">Define Capability</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's defining - must have CAP_WRITE)</label>
                        <input type="text" id="cap-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Scope (on what entity)</label>
                            <input type="text" id="cap-scope" placeholder="e.g. team:engineering">
                        </div>
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="cap-relation" placeholder="e.g. lead, member">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Capability Bits</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="16"> READ (0x10)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="32"> WRITE (0x20)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="64"> DELETE (0x40)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="4"> CREATE (0x04)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="256"> CAP_WRITE (0x100)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="2048"> DELEGATE (0x800)
                            </label>
                        </div>
                        <div style="margin-top: 0.5rem; font-family: monospace; font-size: 0.75rem; color: var(--text-muted);">
                            Selected: <span id="cap-value">0x0000</span> (<span id="cap-decimal">0</span>)
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateCapability()">Define Capability</button>
            </div>

            <div class="card">
                <div class="card-title">Known Capabilities</div>
                <div class="list" id="cap-list">
                    <div class="empty">
                        <div class="empty-icon">âš¡</div>
                        <p>Capabilities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="tab-test" class="tab-content">
            <div class="card">
                <div class="card-title">Check Permission</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Subject (who's asking)</label>
                        <select id="check-subject">
                            <option value="">-- Select entity --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Object (accessing what)</label>
                        <select id="check-object">
                            <option value="">-- Select entity --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Required Capability</label>
                        <select id="check-cap">
                            <option value="16">GRANT_READ (0x0010)</option>
                            <option value="32">GRANT_WRITE (0x0020)</option>
                            <option value="64">GRANT_DELETE (0x0040)</option>
                            <option value="4">ENTITY_CREATE (0x0004)</option>
                            <option value="256">CAP_WRITE (0x0100)</option>
                            <option value="2048">DELEGATE_WRITE (0x0800)</option>
                            <option value="48">READ+WRITE (0x0030)</option>
                            <option value="112">FULL GRANT (0x0070)</option>
                            <option value="0">ANY (0x0000)</option>
                        </select>
                    </div>
                </div>
                <button class="btn success full" onclick="doCheckAccess()">Check Access</button>
                <div id="check-result"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================

        let apiUrl = 'http://localhost:3000';
        let connected = false;

        // Client-side tracking (mirrors what we've created via API)
        const known = {
            entities: [],
            grants: [],
            capabilities: []
        };

        // ============================================================================
        // Logging
        // ============================================================================

        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">${time}</span>${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep log size reasonable
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function logRequest(method, endpoint, body = null) {
            let msg = `<span class="method">${method}</span> ${endpoint}`;
            if (body) {
                msg += ` <span style="color: var(--text-muted)">${JSON.stringify(body)}</span>`;
            }
            log(msg, 'request');
        }

        function logResponse(success, data) {
            if (success) {
                log(`âœ“ ${JSON.stringify(data)}`, 'success');
            } else {
                log(`âœ— ${data}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        function copyLogs() {
            const logDiv = document.getElementById('log');
            const entries = [...logDiv.querySelectorAll('.log-entry')].reverse();
            const text = entries.map(e => e.textContent).join('\n');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    log('Logs copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            log('Logs copied to clipboard!', 'success');
        }

        // ============================================================================
        // API Calls
        // ============================================================================

        async function api(method, endpoint, body = null) {
            logRequest(method, endpoint, body);

            try {
                const opts = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`${apiUrl}${endpoint}`, opts);
                const json = await res.json();

                if (json.success) {
                    logResponse(true, json.data);
                    return { ok: true, data: json.data };
                } else {
                    logResponse(false, json.error);
                    return { ok: false, error: json.error };
                }
            } catch (e) {
                logResponse(false, e.message);
                return { ok: false, error: e.message };
            }
        }

        // ============================================================================
        // Connection
        // ============================================================================

        async function checkConnection() {
            const inputUrl = document.getElementById('api-url').value.trim();
            apiUrl = inputUrl ? inputUrl.replace(/\/$/, '') : '';  // Empty = same origin
            log(`Connecting to ${apiUrl || window.location.origin}...`, 'info');

            const result = await api('GET', '/status');

            if (result.ok) {
                connected = true;
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').textContent =
                    result.data.bootstrapped
                        ? `Connected (root: ${result.data.root_entity})`
                        : 'Connected (not bootstrapped)';
                // Load existing data from server
                await loadData();
            } else {
                connected = false;
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('status-text').textContent = 'Connection failed';
            }
        }

        async function loadData() {
            // Load entities
            const entitiesResult = await api('GET', '/entities');
            if (entitiesResult.ok) {
                known.entities = entitiesResult.data.map(e => ({
                    id: e.id,
                    type: e.entity_type
                }));
            }

            // Load grants
            const grantsResult = await api('GET', '/grants');
            if (grantsResult.ok) {
                known.grants = grantsResult.data.map(g => ({
                    seeker: g.seeker,
                    relation: g.relation,
                    scope: g.scope
                }));
            }

            // Load capabilities
            const capsResult = await api('GET', '/capabilities');
            if (capsResult.ok) {
                known.capabilities = capsResult.data.map(c => ({
                    scope: c.scope,
                    relation: c.relation,
                    cap_mask: c.cap_mask
                }));
            }

            renderAll();
        }

        // ============================================================================
        // Actions
        // ============================================================================

        async function doBootstrap() {
            const rootId = document.getElementById('bootstrap-root').value.trim();
            if (!rootId) return alert('Enter a root ID');

            const result = await api('POST', '/bootstrap', { root_id: rootId });
            if (result.ok) {
                known.entities.push({ id: `user:${rootId}`, type: 'user' });
                renderEntities();
                renderTestSelects();
                checkConnection();
            }
        }

        async function doReset() {
            if (!confirm('Reset entire database? This cannot be undone.')) return;

            const result = await api('POST', '/reset');
            if (result.ok) {
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                renderAll();
                checkConnection();
            }
        }

        async function doCreateEntity() {
            const actor = document.getElementById('entity-actor').value.trim();
            const entityType = document.getElementById('entity-type').value;
            const id = document.getElementById('entity-id').value.trim();

            if (!actor || !id) return alert('Fill all fields');

            const result = await api('POST', '/entity', {
                actor,
                entity_type: entityType,
                id
            });

            if (result.ok) {
                known.entities.push({ id: `${entityType}:${id}`, type: entityType });
                document.getElementById('entity-id').value = '';
                renderEntities();
                renderTestSelects();
            }
        }

        async function doCreateGrant() {
            const actor = document.getElementById('grant-actor').value.trim();
            const seeker = document.getElementById('grant-seeker').value.trim();
            const relation = document.getElementById('grant-relation').value.trim();
            const scope = document.getElementById('grant-scope').value.trim();

            if (!actor || !seeker || !relation || !scope) return alert('Fill all fields');

            const result = await api('POST', '/grant', { actor, seeker, relation, scope });

            if (result.ok) {
                known.grants.push({ seeker, relation, scope });
                document.getElementById('grant-seeker').value = '';
                document.getElementById('grant-relation').value = '';
                document.getElementById('grant-scope').value = '';
                renderGrants();
            }
        }

        async function doCreateCapability() {
            const actor = document.getElementById('cap-actor').value.trim();
            const scope = document.getElementById('cap-scope').value.trim();
            const relation = document.getElementById('cap-relation').value.trim();

            let capMask = 0;
            document.querySelectorAll('.cap-bit:checked').forEach(cb => {
                capMask |= parseInt(cb.value);
            });

            if (!actor || !scope || !relation) return alert('Fill all fields');

            const result = await api('POST', '/capability', {
                actor,
                scope,
                relation,
                cap_mask: capMask
            });

            if (result.ok) {
                known.capabilities.push({ scope, relation, cap_mask: capMask });
                document.getElementById('cap-scope').value = '';
                document.getElementById('cap-relation').value = '';
                document.querySelectorAll('.cap-bit').forEach(cb => cb.checked = false);
                updateCapValue();
                renderCapabilities();
            }
        }

        async function doCheckAccess() {
            const subject = document.getElementById('check-subject').value.trim();
            const object = document.getElementById('check-object').value.trim();
            const required = parseInt(document.getElementById('check-cap').value);

            if (!subject || !object) return alert('Fill subject and object');

            const result = await api('POST', '/check', { subject, object, required });

            const resultDiv = document.getElementById('check-result');
            if (result.ok) {
                const { allowed, effective, effective_string, required_string } = result.data;
                resultDiv.className = `result ${allowed ? 'allowed' : 'denied'}`;
                resultDiv.innerHTML = `
                    <div class="result-icon">${allowed ? 'âœ“' : 'âœ—'}</div>
                    <div class="result-text">${allowed ? 'ACCESS ALLOWED' : 'ACCESS DENIED'}</div>
                    <div class="result-detail">
                        Required: 0x${required.toString(16).padStart(4, '0')} (${required_string})<br>
                        Effective: 0x${effective.toString(16).padStart(4, '0')} (${effective_string})
                    </div>
                `;
            } else {
                resultDiv.className = 'result denied';
                resultDiv.innerHTML = `
                    <div class="result-icon">âš </div>
                    <div class="result-text">ERROR</div>
                    <div class="result-detail">${result.error}</div>
                `;
            }
        }

        // ============================================================================
        // Templates
        // ============================================================================

        async function runTemplate(name) {
            // Check if already bootstrapped
            const status = await api('GET', '/status');
            if (status.ok && status.data.bootstrapped) {
                if (!confirm(`System is already bootstrapped (root: ${status.data.root_entity}).\n\nReset database and run "${name}" template?`)) {
                    return;
                }
                // Reset first
                log('Resetting database...', 'info');
                await api('POST', '/reset');
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
            } else {
                if (!confirm(`Run "${name}" template? This will create entities, grants, and capabilities.`)) return;
            }

            log(`--- Running template: ${name} ---`, 'info');

            if (name === 'startup') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'root' });
                known.entities.push({ id: 'user:root', type: 'user' });

                // Create teams
                for (const t of ['engineering', 'sales']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(50);
                }

                // Create users
                for (const u of ['alice', 'bob', 'charlie', 'dave']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create documents
                for (const d of ['roadmap', 'budget', 'contracts']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'resource', id: d });
                    if (r.ok) known.entities.push({ id: `resource:${d}`, type: 'resource' });
                    await sleep(50);
                }

                log('Defining custom capability meanings...', 'info');

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - Document Access Levels
                // Org bits: 0x01=view, 0x02=comment, 0x04=edit, 0x08=delete
                // Plus GRANT_WRITE (0x20) for owner to grant others
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const docCaps = [
                    { relation: 'viewer',    cap: 0x01, desc: 'view only' },
                    { relation: 'commenter', cap: 0x03, desc: 'view + comment' },
                    { relation: 'editor',    cap: 0x07, desc: 'view + comment + edit' },
                    { relation: 'owner',     cap: 0x2F, desc: 'full control + can grant' }  // 0x20=GRANT_WRITE + 0x0F
                ];

                for (const doc of ['roadmap', 'budget', 'contracts']) {
                    for (const c of docCaps) {
                        await api('POST', '/capability', {
                            actor: 'user:root',
                            scope: `resource:${doc}`,
                            relation: c.relation,
                            cap_mask: c.cap
                        });
                        known.capabilities.push({ scope: `resource:${doc}`, relation: c.relation, cap_mask: c.cap });
                    }
                    await sleep(50);
                }

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - Team Roles
                // Org bits: 0x01=see members, 0x02=add members, 0x04=remove, 0x08=settings
                // Plus system GRANT_WRITE (0x20) for admin to grant roles
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const teamCaps = [
                    { relation: 'member',    cap: 0x01,  desc: 'see team members' },
                    { relation: 'lead',      cap: 0x03,  desc: 'see + add members' },
                    { relation: 'manager',   cap: 0x07,  desc: 'see + add + remove members' },
                    { relation: 'admin',     cap: 0x2F,  desc: 'full team + can grant' }  // 0x20=GRANT_WRITE + 0x0F
                ];

                for (const team of ['engineering', 'sales']) {
                    for (const c of teamCaps) {
                        await api('POST', '/capability', {
                            actor: 'user:root',
                            scope: `team:${team}`,
                            relation: c.relation,
                            cap_mask: c.cap
                        });
                        known.capabilities.push({ scope: `team:${team}`, relation: c.relation, cap_mask: c.cap });
                    }
                    await sleep(50);
                }

                log('Assigning roles...', 'info');

                // Grants - varied access levels
                const grants = [
                    // Alice: eng admin, owns roadmap
                    { actor: 'user:root', seeker: 'user:alice', relation: 'admin', scope: 'team:engineering' },
                    { actor: 'user:root', seeker: 'user:alice', relation: 'owner', scope: 'resource:roadmap' },
                    // Bob: sales lead, can edit budget
                    { actor: 'user:root', seeker: 'user:bob', relation: 'lead', scope: 'team:sales' },
                    { actor: 'user:root', seeker: 'user:bob', relation: 'editor', scope: 'resource:budget' },
                    // Charlie: eng member, can comment on roadmap
                    { actor: 'user:alice', seeker: 'user:charlie', relation: 'member', scope: 'team:engineering' },
                    { actor: 'user:alice', seeker: 'user:charlie', relation: 'commenter', scope: 'resource:roadmap' },
                    // Dave: can only view contracts
                    { actor: 'user:root', seeker: 'user:dave', relation: 'viewer', scope: 'resource:contracts' },
                ];

                for (const g of grants) {
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                    await sleep(50);
                }

            } else if (name === 'saas') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'admin' });
                known.entities.push({ id: 'user:admin', type: 'user' });

                // Create tenant orgs
                for (const t of ['acme', 'globex']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(50);
                }

                // Create users
                for (const u of ['alice', 'bob', 'charlie', 'dana']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create apps/services
                for (const a of ['api-gateway', 'dashboard', 'analytics']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'app', id: a });
                    if (r.ok) known.entities.push({ id: `app:${a}`, type: 'app' });
                    await sleep(50);
                }

                log('Defining SaaS capability tiers...', 'info');

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - API Access Tiers
                // Bits: 0x01=read, 0x02=write, 0x04=delete, 0x08=bulk ops,
                //       0x10=webhooks, 0x20=export, 0x40=admin api, 0x80=unlimited
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const apiCaps = [
                    { relation: 'free',       cap: 0x01,  desc: 'read only' },
                    { relation: 'basic',      cap: 0x03,  desc: 'read + write' },
                    { relation: 'pro',        cap: 0x1F,  desc: 'CRUD + bulk + webhooks' },
                    { relation: 'enterprise', cap: 0xFF,  desc: 'unlimited access' }
                ];

                for (const c of apiCaps) {
                    await api('POST', '/capability', {
                        actor: 'user:admin',
                        scope: 'app:api-gateway',
                        relation: c.relation,
                        cap_mask: c.cap
                    });
                    known.capabilities.push({ scope: 'app:api-gateway', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - Dashboard Features
                // Bits: 0x01=view, 0x02=create reports, 0x04=share, 0x08=schedule
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const dashCaps = [
                    { relation: 'viewer',     cap: 0x01, desc: 'view dashboards' },
                    { relation: 'analyst',    cap: 0x07, desc: 'view + create + share' },
                    { relation: 'power-user', cap: 0x0F, desc: 'full dashboard control' }
                ];

                for (const c of dashCaps) {
                    await api('POST', '/capability', {
                        actor: 'user:admin',
                        scope: 'app:dashboard',
                        relation: c.relation,
                        cap_mask: c.cap
                    });
                    known.capabilities.push({ scope: 'app:dashboard', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - Analytics Access
                // Bits: 0x01=basic metrics, 0x02=advanced, 0x04=raw data, 0x08=ML models
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const analyticsCaps = [
                    { relation: 'basic',    cap: 0x01, desc: 'basic metrics' },
                    { relation: 'advanced', cap: 0x03, desc: 'basic + advanced analytics' },
                    { relation: 'data-eng', cap: 0x07, desc: 'all + raw data access' },
                    { relation: 'ml-admin', cap: 0x0F, desc: 'full + ML model access' }
                ];

                for (const c of analyticsCaps) {
                    await api('POST', '/capability', {
                        actor: 'user:admin',
                        scope: 'app:analytics',
                        relation: c.relation,
                        cap_mask: c.cap
                    });
                    known.capabilities.push({ scope: 'app:analytics', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // CUSTOM ORG CAPABILITIES - Tenant Roles
                // Bits: 0x100=view org, 0x200=invite users, 0x400=billing, 0x800=settings
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const tenantCaps = [
                    { relation: 'member',  cap: 0x100,  desc: 'org member' },
                    { relation: 'manager', cap: 0x300,  desc: 'member + invite' },
                    { relation: 'billing', cap: 0x500,  desc: 'member + billing' },
                    { relation: 'owner',   cap: 0xF00,  desc: 'full org control' }
                ];

                for (const tenant of ['acme', 'globex']) {
                    for (const c of tenantCaps) {
                        await api('POST', '/capability', {
                            actor: 'user:admin',
                            scope: `team:${tenant}`,
                            relation: c.relation,
                            cap_mask: c.cap
                        });
                        known.capabilities.push({ scope: `team:${tenant}`, relation: c.relation, cap_mask: c.cap });
                    }
                }
                await sleep(50);

                log('Assigning SaaS access...', 'info');

                // Grants - simulate real SaaS scenario
                const grants = [
                    // Alice: Acme owner, enterprise API, power-user dashboard
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'owner', scope: 'team:acme' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'enterprise', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'power-user', scope: 'app:dashboard' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'ml-admin', scope: 'app:analytics' },
                    // Bob: Acme member, pro API, analyst dashboard
                    { actor: 'user:alice', seeker: 'user:bob', relation: 'member', scope: 'team:acme' },
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'pro', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'analyst', scope: 'app:dashboard' },
                    // Charlie: Globex owner, basic tier
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'owner', scope: 'team:globex' },
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'basic', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'viewer', scope: 'app:dashboard' },
                    // Dana: Globex member, free tier
                    { actor: 'user:charlie', seeker: 'user:dana', relation: 'member', scope: 'team:globex' },
                    { actor: 'user:admin', seeker: 'user:dana', relation: 'free', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:dana', relation: 'basic', scope: 'app:analytics' },
                ];

                for (const g of grants) {
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                    await sleep(50);
                }
            }

            log(`--- Template "${name}" complete ---`, 'info');
            renderAll();
            checkConnection();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================================================
        // UI
        // ============================================================================

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${name}')"]`).classList.add('active');
        }

        function updateCapValue() {
            let cap = 0;
            document.querySelectorAll('.cap-bit:checked').forEach(cb => {
                cap |= parseInt(cb.value);
            });
            document.getElementById('cap-value').textContent = '0x' + cap.toString(16).padStart(4, '0');
            document.getElementById('cap-decimal').textContent = cap;
        }

        function renderAll() {
            renderEntities();
            renderGrants();
            renderCapabilities();
            renderTestSelects();
        }

        function renderTestSelects() {
            const subjectSelect = document.getElementById('check-subject');
            const objectSelect = document.getElementById('check-object');

            // Filter out system _type: entities from dropdowns
            const orgEntities = known.entities.filter(e => !e.id.startsWith('_type:'));
            const options = orgEntities.map(e =>
                `<option value="${e.id}">${e.id}</option>`
            ).join('');

            const placeholder = '<option value="">-- Select entity --</option>';
            subjectSelect.innerHTML = placeholder + options;
            objectSelect.innerHTML = placeholder + options;
        }

        function renderEntities() {
            const list = document.getElementById('entity-list');
            // Filter out system _type: entities
            const orgEntities = known.entities.filter(e => !e.id.startsWith('_type:'));
            if (orgEntities.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ“‹</div><p>No entities yet</p></div>';
                return;
            }
            list.innerHTML = orgEntities.map(e => `
                <div class="list-item">
                    <span class="chip ${e.type}"><span class="type">${e.type}:</span>${e.id.split(':')[1]}</span>
                </div>
            `).join('');
        }

        function renderGrants() {
            const list = document.getElementById('grant-list');
            // Filter out system _type: grants (root's admin on _type:*)
            const orgGrants = known.grants.filter(g => !g.scope.startsWith('_type:'));
            if (orgGrants.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ”—</div><p>No grants yet</p></div>';
                return;
            }
            list.innerHTML = orgGrants.map(g => {
                const seekerType = g.seeker.split(':')[0];
                const scopeType = g.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${g.seeker.split(':')[1]}</span>
                        <span class="arrow">â†’</span>
                        <span class="relation-badge">${g.relation}</span>
                        <span class="arrow">â†’</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${g.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderCapabilities() {
            const list = document.getElementById('cap-list');
            // Filter out system _type: capabilities (bootstrap admin caps)
            const orgCaps = known.capabilities.filter(c => !c.scope.startsWith('_type:'));
            if (orgCaps.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">âš¡</div><p>No capabilities yet</p></div>';
                return;
            }
            list.innerHTML = orgCaps.map(c => {
                const scopeType = c.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${c.scope.split(':')[1]}</span>
                        <span class="relation-badge">${c.relation}</span>
                        <span class="cap-badge">0x${c.cap_mask.toString(16).padStart(4, '0')}</span>
                    </div>
                `;
            }).join('');
        }

        // Init
        document.querySelectorAll('.cap-bit').forEach(cb => {
            cb.addEventListener('change', updateCapValue);
        });

        // Auto-connect on load
        checkConnection();
    </script>
</body>
</html>
