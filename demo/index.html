<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capbit Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }

        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
        }

        h1 { font-size: 1.5rem; font-weight: 700; }
        h1 span { color: var(--primary); }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected { background: var(--success); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-row.stack { flex-direction: column; }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        select, input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.625rem;
            color: var(--text);
            font-size: 0.875rem;
            width: 100%;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        .btn.danger { background: var(--danger); }
        .btn.success { background: var(--success); }
        .btn.warning { background: var(--warning); }
        .btn.outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn.full { width: 100%; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-group .btn { flex: 1; }

        /* Log */
        .log {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.7rem;
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
            word-break: break-all;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--primary); }
        .log-entry.request { color: var(--warning); }
        .log-entry .time { color: var(--text-muted); margin-right: 0.5rem; }
        .log-entry .method {
            background: var(--bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }

        /* Result box */
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .result.allowed { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); }
        .result.denied { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); }

        .result-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .result-text { font-weight: 600; font-size: 1rem; }
        .result-detail { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-input);
            border-radius: 6px;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .chip .type { color: var(--primary); font-weight: 600; }
        .chip.user .type { color: #22c55e; }
        .chip.team .type { color: #f59e0b; }
        .chip.app .type { color: #ec4899; }
        .chip.resource .type { color: #06b6d4; }

        /* Lists */
        .list { display: flex; flex-direction: column; gap: 0.5rem; }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8125rem;
            flex-wrap: wrap;
        }

        .list-item .arrow { color: var(--text-muted); }

        .relation-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .cap-badge {
            font-family: monospace;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Config panel */
        .config-panel {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-row input {
            flex: 1;
        }

        .hidden { display: none !important; }

        /* FAB (Floating Action Button) */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 200;
            transition: transform 0.2s, background 0.2s;
        }
        .fab:hover { background: var(--primary-dark); }
        .fab:active { transform: scale(0.95); }
        .fab.open { transform: rotate(45deg); }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }

        /* Bottom sheet modal */
        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 85vh;
            background: var(--bg-card);
            border-radius: 1rem 1rem 0 0;
            z-index: 301;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            overflow-y: auto;
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }
        .modal-header h3 { font-size: 1rem; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .modal-content { padding: 1rem; }

        /* Action menu in modal */
        .action-menu { display: flex; flex-direction: column; gap: 0.5rem; }
        .action-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            border: none;
            color: var(--text);
            text-align: left;
            font-size: 0.9rem;
        }
        .action-item:hover { background: var(--border); }
        .action-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .action-icon.entity { background: rgba(34, 197, 94, 0.2); }
        .action-icon.cap { background: rgba(99, 102, 241, 0.2); }
        .action-icon.grant { background: rgba(245, 158, 11, 0.2); }
        .action-icon.delegate { background: rgba(236, 72, 153, 0.2); }

        /* Section headers in view tabs */
        .section-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin: 1rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Segmented control (different from main tabs) */
        .seg-btn {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .seg-btn:first-child { border-radius: 6px 0 0 6px; }
        .seg-btn:last-child { border-radius: 0 6px 6px 0; }
        .seg-btn:not(:last-child) { border-right: none; }
        .seg-btn.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .seg-btn:hover:not(.active) { background: var(--border); }

        /* Accordion */
        .accordion {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem 1rem;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
        }
        .accordion-header:hover { background: rgba(255,255,255,0.03); }
        .accordion-arrow {
            font-size: 0.65rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .accordion-content {
            display: none;
            padding: 0 1rem 1rem 1rem;
        }
        .accordion-content.open { display: block; }
        .count {
            display: inline-block;
            background: var(--bg-input);
            color: var(--text-muted);
            font-size: 0.65rem;
            font-weight: 500;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* FAB Menu Groups */
        .menu-group-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding: 0.75rem 0 0.25rem 0;
        }
        .menu-group-label:first-child { padding-top: 0; }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem;">
            <h1>Cap<span>bit</span></h1>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div class="status-dot" id="status-dot"></div>
                <select id="current-viewer" onchange="setViewer(this.value)" style="font-size: 0.7rem; padding: 0.35rem 0.5rem; border-radius: 6px; min-width: 100px;">
                    <option value="user:root">user:root</option>
                </select>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')" id="tab-btn-home">Home</button>
            <button class="tab" onclick="showTab('query')">Query</button>
            <button class="tab" onclick="showTab('logs')">Logs</button>
            <button class="tab" onclick="showTab('setup')">Setup</button>
        </div>

        <!-- Setup Tab -->
        <div id="tab-setup" class="tab-content">
            <div class="card">
                <div class="card-title">Bootstrap System</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Root User ID</label>
                        <input type="text" id="bootstrap-root" value="root" placeholder="e.g. root, admin">
                    </div>
                </div>
                <button class="btn full" onclick="doBootstrap()">Bootstrap</button>
            </div>

            <div class="card">
                <div class="card-title">Quick Setup Templates</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Run a template to populate the system. Watch the log to see each API call.
                </p>
                <div class="btn-group">
                    <button class="btn warning" onclick="runTemplate('startup')">Startup</button>
                    <button class="btn warning" onclick="runTemplate('saas')">SaaS</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Danger Zone</div>
                <button class="btn danger full" onclick="doReset()">Reset Database</button>
            </div>
        </div>

        <!-- Home Tab (Combined Entities + Permissions) -->
        <div id="tab-home" class="tab-content active">
            <!-- Entities Section -->
            <div class="accordion" data-section="entities">
                <button class="accordion-header" onclick="toggleAccordion('entities')">
                    <span>Entities <span class="count" id="count-entities">0</span></span>
                    <span class="accordion-arrow">‚ñº</span>
                </button>
                <div class="accordion-content open" id="section-entities">
                    <div class="list" id="entity-list">
                        <div class="empty">
                            <div class="empty-icon">üìã</div>
                            <p>No entities yet</p>
                            <button class="btn sm" style="margin-top: 0.5rem;" onclick="toggleModal(); showForm('entity');">+ Create Entity</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capability Bits Section -->
            <div class="accordion" data-section="capbits">
                <button class="accordion-header" onclick="toggleAccordion('capbits')">
                    <span>Capability Bits <span class="count" id="count-capbits">0</span></span>
                    <span class="accordion-arrow">‚ñ∂</span>
                </button>
                <div class="accordion-content" id="section-capbits">
                    <div id="primitive-cap-list">
                        <div class="empty">
                            <div class="empty-icon">üîπ</div>
                            <p>No capability bits defined</p>
                            <button class="btn sm" style="margin-top: 0.5rem;" onclick="toggleModal(); showForm('cap-bit');">+ Define Bit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relations Section -->
            <div class="accordion" data-section="relations">
                <button class="accordion-header" onclick="toggleAccordion('relations')">
                    <span>Relations <span class="count" id="count-relations">0</span></span>
                    <span class="accordion-arrow">‚ñ∂</span>
                </button>
                <div class="accordion-content" id="section-relations">
                    <div class="list" id="cap-list">
                        <div class="empty">
                            <div class="empty-icon">‚ö°</div>
                            <p>No relations defined</p>
                            <button class="btn sm" style="margin-top: 0.5rem;" onclick="toggleModal(); showForm('relation');">+ Define Relation</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grants Section -->
            <div class="accordion" data-section="grants">
                <button class="accordion-header" onclick="toggleAccordion('grants')">
                    <span>Grants <span class="count" id="count-grants">0</span></span>
                    <span class="accordion-arrow">‚ñ∂</span>
                </button>
                <div class="accordion-content" id="section-grants">
                    <div class="list" id="grant-list">
                        <div class="empty">
                            <div class="empty-icon">üîó</div>
                            <p>No grants yet</p>
                            <button class="btn sm" style="margin-top: 0.5rem;" onclick="toggleModal(); showForm('grant');">+ Create Grant</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delegations Section -->
            <div class="accordion" data-section="delegations">
                <button class="accordion-header" onclick="toggleAccordion('delegations')">
                    <span>Delegations <span class="count" id="count-delegations">0</span></span>
                    <span class="accordion-arrow">‚ñ∂</span>
                </button>
                <div class="accordion-content" id="section-delegations">
                    <div class="list" id="delegation-list">
                        <div class="empty">
                            <div class="empty-icon">‚ÜóÔ∏è</div>
                            <p>No delegations yet</p>
                            <button class="btn sm" style="margin-top: 0.5rem;" onclick="toggleModal(); showForm('delegate');">+ Create Delegation</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Query Tab -->
        <div id="tab-query" class="tab-content">
            <div class="card">
                <!-- Query Mode Selector - segmented control style -->
                <div class="segmented-control" style="display: flex; gap: 0.25rem; margin-bottom: 1rem;">
                    <button class="seg-btn active" data-mode="check" onclick="showQueryMode('check')">Check</button>
                    <button class="seg-btn" data-mode="accessible" onclick="showQueryMode('accessible')">By Subject</button>
                    <button class="seg-btn" data-mode="subjects" onclick="showQueryMode('subjects')">By Object</button>
                </div>

                <!-- Check Access Mode -->
                <div id="query-check">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        Does subject have required capability on object?
                    </p>
                    <div class="form-row stack">
                        <div class="input-group">
                            <label>Subject</label>
                            <select id="check-subject">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Object</label>
                            <select id="check-object">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Required Capability</label>
                            <select id="check-cap">
                                <option value="0">0x0000 (ANY)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn success full" onclick="doCheckAccess()">Check</button>
                    <div id="check-result"></div>
                </div>

                <!-- Outbound: What can subject access? -->
                <div id="query-accessible" class="hidden">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        What objects can this subject access? (outbound grants)
                    </p>
                    <div class="form-row stack">
                        <div class="input-group">
                            <label>Subject</label>
                            <select id="query-subject">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn success full" onclick="doQueryAccessible()">Query</button>
                    <div id="accessible-result"></div>
                </div>

                <!-- Inbound: Who can access object? -->
                <div id="query-subjects" class="hidden">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        Who has access to this object? (inbound grants)
                    </p>
                    <div class="form-row stack">
                        <div class="input-group">
                            <label>Object</label>
                            <select id="query-object">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn success full" onclick="doQuerySubjects()">Query</button>
                    <div id="subjects-result"></div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content">
            <div class="card">
                <div class="card-title">
                    Activity Log
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn sm outline" onclick="copyLogs()">Copy</button>
                        <button class="btn sm outline" onclick="clearLog()">Clear</button>
                    </div>
                </div>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" id="fab" onclick="toggleModal()">+</button>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Create</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <!-- Action Menu (default view) -->
                <div id="modal-menu" class="action-menu">
                    <div class="menu-group-label">Create</div>
                    <button class="action-item" onclick="showForm('type')">
                        <span class="action-icon" style="background: rgba(139, 92, 246, 0.2);">T</span>
                        <div><strong>Type</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Define a new entity type</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('entity')">
                        <span class="action-icon entity">+</span>
                        <div><strong>Entity</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Add user, team, app, or resource</span></div>
                    </button>

                    <div class="menu-group-label">Define</div>
                    <button class="action-item" onclick="showForm('cap-bit')">
                        <span class="action-icon cap">0</span>
                        <div><strong>Capability Bit</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Label a bit on an entity type</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('relation')">
                        <span class="action-icon cap">=</span>
                        <div><strong>Relation</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Set capability mask for a relation</span></div>
                    </button>

                    <div class="menu-group-label">Assign</div>
                    <button class="action-item" onclick="showForm('grant')">
                        <span class="action-icon grant">&#8594;</span>
                        <div><strong>Grant</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Assign a relation to a user</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('delegate')">
                        <span class="action-icon delegate">&#8599;</span>
                        <div><strong>Delegation</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Inherit permissions from another</span></div>
                    </button>
                </div>

                <!-- Type Form -->
                <div id="form-type" class="hidden">
                    <div class="input-group">
                        <label>Actor</label>
                        <input type="text" id="m-type-actor" value="user:root">
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Type Name</label>
                        <input type="text" id="m-type-name" placeholder="e.g. project, document">
                    </div>
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Creates a new entity type and _type:{name} entity. Requires TYPE_CREATE on _type:_type.
                    </p>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateTypeModal()">Create Type</button>
                </div>

                <!-- Entity Form -->
                <div id="form-entity" class="hidden">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Type</label>
                            <select id="m-entity-type">
                                <option value="user">user</option>
                                <option value="team">team</option>
                                <option value="app">app</option>
                                <option value="resource">resource</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ID</label>
                            <input type="text" id="m-entity-id" placeholder="e.g. alice">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Actor</label>
                        <input type="text" id="m-entity-actor" value="user:root">
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateEntityModal()">Create Entity</button>
                </div>

                <!-- Capability Bit Form -->
                <div id="form-cap-bit" class="hidden">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Entity Type</label>
                            <select id="m-label-scope">
                                <option value="_type:resource">_type:resource</option>
                                <option value="_type:user">_type:user</option>
                                <option value="_type:team">_type:team</option>
                                <option value="_type:app">_type:app</option>
                                <option value="_type:_type">_type:_type</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Bit (0-15)</label>
                            <input type="number" id="m-label-bit" min="0" max="15" value="0" style="width: 70px;">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Label</label>
                        <input type="text" id="m-label-name" placeholder="e.g. read, write, enter">
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doDefineCapLabelModal()">Define Bit</button>
                </div>

                <!-- Relation Form -->
                <div id="form-relation" class="hidden">
                    <div class="input-group">
                        <label>Actor</label>
                        <input type="text" id="m-cap-actor" value="user:root">
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <div class="input-group">
                            <label>Entity</label>
                            <select id="m-cap-scope" onchange="updateRelationDropdown(); updateCapBitLabels();">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Relation</label>
                            <select id="m-cap-relation" onchange="handleRelationSelect()">
                                <option value="">-- Select entity first --</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group hidden" id="m-cap-new-relation-group" style="margin-top: 0.5rem;">
                        <label>New Relation Name</label>
                        <input type="text" id="m-cap-new-relation" placeholder="e.g. employee">
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Capability Bits</label>
                        <div id="m-cap-labels" style="display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.25rem;">
                            <span style="color: var(--text-muted); font-size: 0.8rem;">Select an entity to see available capability bits</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 0.5rem;">
                            <span style="font-family: monospace; font-size: 0.85rem;">Mask = <strong id="m-cap-value">0x0000</strong></span>
                            <button class="btn sm outline" type="button" onclick="showForm('cap-bit')">+ Define New Bit</button>
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateCapabilityModal()">Define Relation</button>
                </div>

                <!-- Grant Form -->
                <div id="form-grant" class="hidden">
                    <div class="input-group">
                        <label>Actor</label>
                        <input type="text" id="m-grant-actor" value="user:root">
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Seeker (who gets the grant)</label>
                        <input type="text" id="m-grant-seeker" placeholder="e.g. user:alice">
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="m-grant-relation" placeholder="e.g. employee">
                        </div>
                        <div class="input-group">
                            <label>Scope</label>
                            <input type="text" id="m-grant-scope" placeholder="e.g. resource:office">
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateGrantModal()">Create Grant</button>
                </div>

                <!-- Delegate Form -->
                <div id="form-delegate" class="hidden">
                    <div class="input-group">
                        <label>Actor</label>
                        <input type="text" id="m-deleg-actor" value="user:root">
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Seeker (who inherits)</label>
                        <input type="text" id="m-deleg-seeker" placeholder="e.g. user:bob">
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <div class="input-group">
                            <label>Scope</label>
                            <input type="text" id="m-deleg-scope" placeholder="e.g. resource:office">
                        </div>
                        <div class="input-group">
                            <label>Inherit From</label>
                            <input type="text" id="m-deleg-source" placeholder="e.g. user:alice">
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateDelegationModal()">Create Delegation</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================

        let apiUrl = 'http://localhost:3000';
        let connected = false;
        let currentViewer = 'user:root';  // Who is viewing the demo

        // SYSTEM_READ capability - bit 13 on _type:_type scope (matches SystemCap::SYSTEM_READ)
        const SYSTEM_READ_SCOPE = '_type:_type';
        const SYSTEM_READ_BIT = 0x2000;  // bit 13 = SystemCap::SYSTEM_READ

        // Client-side tracking (mirrors what we've created via API)
        const known = {
            entities: [],
            grants: [],
            capabilities: [],
            delegations: [],
            capLabels: []  // {scope, bit, label} - primitive capability definitions
        };

        // ============================================================================
        // Modal
        // ============================================================================

        let modalBits = 0;

        function toggleModal() {
            const overlay = document.getElementById('modal-overlay');
            const fab = document.getElementById('fab');
            if (overlay.classList.contains('open')) {
                closeModal();
            } else {
                overlay.classList.add('open');
                fab.classList.add('open');
                showMenu();
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('open');
            document.getElementById('fab').classList.remove('open');
        }

        function showMenu() {
            document.getElementById('modal-title').textContent = 'Create';
            document.getElementById('modal-menu').classList.remove('hidden');
            document.querySelectorAll('[id^="form-"]').forEach(f => f.classList.add('hidden'));
        }

        function showForm(name) {
            const titles = {
                'type': 'Create Type',
                'entity': 'Create Entity',
                'cap-bit': 'Define Capability Bit',
                'relation': 'Define Relation',
                'grant': 'Create Grant',
                'delegate': 'Create Delegation'
            };
            document.getElementById('modal-title').textContent = titles[name] || 'Create';
            document.getElementById('modal-menu').classList.add('hidden');
            document.querySelectorAll('[id^="form-"]').forEach(f => f.classList.add('hidden'));
            document.getElementById(`form-${name}`).classList.remove('hidden');

            if (name === 'relation') {
                populateRelationEntityDropdown();
            }
        }

        function populateRelationEntityDropdown() {
            const select = document.getElementById('m-cap-scope');
            select.innerHTML = '<option value="">-- Select entity --</option>';

            // Add all known entities to the dropdown
            known.entities.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.id;
                select.appendChild(opt);
            });

            // Reset relation dropdown
            document.getElementById('m-cap-relation').innerHTML = '<option value="">-- Select entity first --</option>';
            document.getElementById('m-cap-new-relation-group').classList.add('hidden');
            document.getElementById('m-cap-new-relation').value = '';

            // Reset capability labels section
            modalBits = 0;
            document.getElementById('m-cap-value').textContent = '0x0000';
            document.getElementById('m-cap-labels').innerHTML =
                '<span style="color: var(--text-muted); font-size: 0.8rem;">Select an entity to see available capability bits</span>';
        }

        function updateRelationDropdown() {
            const scope = document.getElementById('m-cap-scope').value;
            const select = document.getElementById('m-cap-relation');

            if (!scope) {
                select.innerHTML = '<option value="">-- Select entity first --</option>';
                document.getElementById('m-cap-new-relation-group').classList.add('hidden');
                return;
            }

            // Find existing relations defined on this entity
            const existingRelations = known.capabilities
                .filter(c => c.scope === scope)
                .map(c => c.relation);
            const uniqueRelations = [...new Set(existingRelations)];

            let options = '<option value="">-- Select or add new --</option>';
            uniqueRelations.forEach(r => {
                options += `<option value="${r}">${r}</option>`;
            });
            options += '<option value="__new__">+ Add new relation...</option>';

            select.innerHTML = options;
            document.getElementById('m-cap-new-relation-group').classList.add('hidden');
        }

        function handleRelationSelect() {
            const select = document.getElementById('m-cap-relation');
            const newGroup = document.getElementById('m-cap-new-relation-group');

            if (select.value === '__new__') {
                newGroup.classList.remove('hidden');
                document.getElementById('m-cap-new-relation').focus();
            } else {
                newGroup.classList.add('hidden');
                document.getElementById('m-cap-new-relation').value = '';
            }
        }

        function initModalBitSelector() {
            const container = document.getElementById('m-bit-selector');
            container.innerHTML = '';
            modalBits = 0;
            for (let i = 0; i < 16; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'm-bit-btn';
                btn.dataset.bit = i;
                btn.textContent = i;
                btn.style.cssText = 'padding: 0.25rem; font-size: 0.65rem; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-muted); border-radius: 4px; cursor: pointer;';
                btn.onclick = () => toggleModalBit(i);
                container.appendChild(btn);
            }
            updateModalBitDisplay();
        }

        function toggleModalBit(bit) {
            modalBits ^= (1 << bit);
            updateModalBitDisplay();
        }

        function updateModalBitDisplay() {
            document.querySelectorAll('.m-bit-btn').forEach(btn => {
                const bit = parseInt(btn.dataset.bit);
                const isSet = (modalBits & (1 << bit)) !== 0;
                btn.style.background = isSet ? 'var(--primary)' : 'var(--bg-input)';
                btn.style.color = isSet ? 'white' : 'var(--text-muted)';
            });
            document.getElementById('m-cap-value').textContent = '0x' + modalBits.toString(16).padStart(4, '0');
        }

        function updateCapBitLabels() {
            const scope = document.getElementById('m-cap-scope').value;
            const container = document.getElementById('m-cap-labels');

            if (!scope || !scope.includes(':')) {
                container.innerHTML = '<span style="color: var(--text-muted); font-size: 0.8rem;">Select an entity to see available capability bits</span>';
                modalBits = 0;
                document.getElementById('m-cap-value').textContent = '0x0000';
                return;
            }

            // Get the type from the scope (e.g., "resource:office" -> "_type:resource")
            const entityType = scope.split(':')[0];
            const typeScope = `_type:${entityType}`;

            // Find labels for this type
            const labels = known.capLabels.filter(l => l.scope === typeScope).sort((a, b) => a.bit - b.bit);

            // Reset modalBits
            modalBits = 0;
            document.getElementById('m-cap-value').textContent = '0x0000';

            if (labels.length === 0) {
                container.innerHTML = `
                    <div style="padding: 0.75rem; background: var(--bg-input); border-radius: 6px; text-align: center;">
                        <span style="color: var(--text-muted); font-size: 0.8rem;">No capability bits defined for <strong>${typeScope}</strong></span>
                        <br><br>
                        <button class="btn sm outline" type="button" onclick="showForm('cap-bit'); document.getElementById('m-label-scope').value = '${typeScope}';">
                            + Define Capability Bits
                        </button>
                    </div>
                `;
                return;
            }

            // Create checkboxes for each label
            container.innerHTML = labels.map(l => {
                const mask = 1 << l.bit;
                return `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" class="cap-label-cb" data-bit="${l.bit}" onchange="toggleCapLabel(${l.bit})" style="width: auto;">
                        <span style="flex: 1;"><strong>${l.label}</strong></span>
                        <span style="font-family: monospace; font-size: 0.75rem; color: var(--text-muted);">bit ${l.bit} = 0x${mask.toString(16).padStart(2, '0')}</span>
                    </label>
                `;
            }).join('');
        }

        function toggleCapLabel(bit) {
            modalBits ^= (1 << bit);
            document.getElementById('m-cap-value').textContent = '0x' + modalBits.toString(16).padStart(4, '0');
        }

        // Modal form handlers
        async function doCreateTypeModal() {
            const actor = document.getElementById('m-type-actor').value.trim();
            const typeName = document.getElementById('m-type-name').value.trim();
            if (!actor || !typeName) return alert('Fill all fields');

            // Call the create_type API (need to add this endpoint)
            const result = await api('POST', '/type', { actor, type_name: typeName });
            if (result.ok) {
                known.entities.push({ id: `_type:${typeName}`, type: '_type' });
                document.getElementById('m-type-name').value = '';
                renderAll();
                closeModal();
            }
        }

        async function doCreateEntityModal() {
            const actor = document.getElementById('m-entity-actor').value.trim();
            const entityType = document.getElementById('m-entity-type').value;
            const id = document.getElementById('m-entity-id').value.trim();
            if (!actor || !id) return alert('Fill all fields');

            const result = await api('POST', '/entity', { actor, entity_type: entityType, id });
            if (result.ok) {
                known.entities.push({ id: `${entityType}:${id}`, type: entityType });
                document.getElementById('m-entity-id').value = '';
                renderAll();
                closeModal();
            }
        }

        async function doDefineCapLabelModal() {
            const scope = document.getElementById('m-label-scope').value;
            const bit = parseInt(document.getElementById('m-label-bit').value);
            const label = document.getElementById('m-label-name').value.trim();
            if (!label) return alert('Enter a label');

            const result = await api('POST', '/cap-label', { scope, bit, label });
            if (result.ok) {
                const existing = known.capLabels.findIndex(l => l.scope === scope && l.bit === bit);
                if (existing >= 0) known.capLabels[existing].label = label;
                else known.capLabels.push({ scope, bit, label });
                document.getElementById('m-label-name').value = '';
                renderAll();
                closeModal();
            }
        }

        async function doCreateCapabilityModal() {
            const actor = document.getElementById('m-cap-actor').value.trim();
            const scope = document.getElementById('m-cap-scope').value;
            const relationSelect = document.getElementById('m-cap-relation').value;

            // Get relation name from dropdown or new input
            let relation;
            if (relationSelect === '__new__') {
                relation = document.getElementById('m-cap-new-relation').value.trim();
            } else {
                relation = relationSelect;
            }

            if (!actor || !scope || !relation) return alert('Fill all fields');
            if (modalBits === 0) return alert('Select at least one capability bit');

            const result = await api('POST', '/capability', { actor, scope, relation, cap_mask: modalBits });
            if (result.ok) {
                // Update or add to known capabilities
                const existing = known.capabilities.findIndex(c => c.scope === scope && c.relation === relation);
                if (existing >= 0) {
                    known.capabilities[existing].cap_mask = modalBits;
                } else {
                    known.capabilities.push({ scope, relation, cap_mask: modalBits });
                }
                document.getElementById('m-cap-scope').value = '';
                document.getElementById('m-cap-relation').value = '';
                document.getElementById('m-cap-new-relation').value = '';
                document.getElementById('m-cap-new-relation-group').classList.add('hidden');
                modalBits = 0;
                renderAll();
                closeModal();
            }
        }

        async function doCreateGrantModal() {
            const actor = document.getElementById('m-grant-actor').value.trim();
            const seeker = document.getElementById('m-grant-seeker').value.trim();
            const relation = document.getElementById('m-grant-relation').value.trim();
            const scope = document.getElementById('m-grant-scope').value.trim();
            if (!actor || !seeker || !relation || !scope) return alert('Fill all fields');

            const result = await api('POST', '/grant', { actor, seeker, relation, scope });
            if (result.ok) {
                known.grants.push({ seeker, relation, scope });
                document.getElementById('m-grant-seeker').value = '';
                document.getElementById('m-grant-relation').value = '';
                document.getElementById('m-grant-scope').value = '';
                renderAll();
                closeModal();
            }
        }

        async function doCreateDelegationModal() {
            const actor = document.getElementById('m-deleg-actor').value.trim();
            const seeker = document.getElementById('m-deleg-seeker').value.trim();
            const scope = document.getElementById('m-deleg-scope').value.trim();
            const delegate = document.getElementById('m-deleg-source').value.trim();
            if (!actor || !seeker || !scope || !delegate) return alert('Fill all fields');

            const result = await api('POST', '/delegation', { actor, seeker, scope, delegate });
            if (result.ok) {
                known.delegations.push({ seeker, scope, delegate });
                document.getElementById('m-deleg-seeker').value = '';
                document.getElementById('m-deleg-scope').value = '';
                document.getElementById('m-deleg-source').value = '';
                renderAll();
                closeModal();
            }
        }

        // ============================================================================
        // Logging
        // ============================================================================

        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">${time}</span>${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep log size reasonable
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function logRequest(method, endpoint, body = null) {
            let msg = `<span class="method">${method}</span> ${endpoint}`;
            if (body) {
                msg += ` <span style="color: var(--text-muted)">${JSON.stringify(body)}</span>`;
            }
            log(msg, 'request');
        }

        function logResponse(success, data) {
            if (success) {
                log(`‚úì ${JSON.stringify(data)}`, 'success');
            } else {
                log(`‚úó ${data}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        function copyLogs() {
            const logDiv = document.getElementById('log');
            const entries = [...logDiv.querySelectorAll('.log-entry')].reverse();
            const text = entries.map(e => e.textContent).join('\n');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    log('Logs copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            log('Logs copied to clipboard!', 'success');
        }

        // ============================================================================
        // API Calls
        // ============================================================================

        async function api(method, endpoint, body = null) {
            logRequest(method, endpoint, body);

            try {
                const opts = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`${apiUrl}${endpoint}`, opts);
                const json = await res.json();

                if (json.success) {
                    logResponse(true, json.data);
                    return { ok: true, data: json.data };
                } else {
                    logResponse(false, json.error);
                    return { ok: false, error: json.error };
                }
            } catch (e) {
                logResponse(false, e.message);
                return { ok: false, error: e.message };
            }
        }

        // ============================================================================
        // Connection
        // ============================================================================

        async function checkConnection() {
            apiUrl = '';  // Use same origin (server serves demo at /)
            log(`Connecting to ${window.location.origin}...`, 'info');

            const result = await api('GET', '/status');

            if (result.ok) {
                connected = true;
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-dot').title = result.data.bootstrapped
                    ? `Connected (root: ${result.data.root_entity})`
                    : 'Connected (not bootstrapped)';
                // Load existing data from server
                await loadData();
            } else {
                connected = false;
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('status-dot').title = 'Connection failed';
            }
        }

        async function loadData() {
            // Load entities
            const entitiesResult = await api('GET', '/entities');
            if (entitiesResult.ok) {
                known.entities = entitiesResult.data.map(e => ({
                    id: e.id,
                    type: e.entity_type
                }));
            }

            // Load grants
            const grantsResult = await api('GET', '/grants');
            if (grantsResult.ok) {
                known.grants = grantsResult.data.map(g => ({
                    seeker: g.seeker,
                    relation: g.relation,
                    scope: g.scope
                }));
            }

            // Load capabilities
            const capsResult = await api('GET', '/capabilities');
            if (capsResult.ok) {
                known.capabilities = capsResult.data.map(c => ({
                    scope: c.scope,
                    relation: c.relation,
                    cap_mask: c.cap_mask
                }));
            }

            // Load capability bit labels
            const labelsResult = await api('GET', '/cap-labels');
            if (labelsResult.ok) {
                known.capLabels = labelsResult.data.map(l => ({
                    scope: l.scope,
                    bit: l.bit,  // Already a bit number
                    label: l.label
                }));
            }

            // Check viewer's permission to see system entities
            await updateViewerPermission();
        }

        // ============================================================================
        // Actions
        // ============================================================================

        async function doBootstrap() {
            const rootId = document.getElementById('bootstrap-root').value.trim();
            if (!rootId) return alert('Enter a root ID');

            const result = await api('POST', '/bootstrap', { root_id: rootId });
            if (result.ok) {
                known.entities.push({ id: `user:${rootId}`, type: 'user' });
                renderEntities();
                renderTestSelects();
                checkConnection();
            }
        }

        async function doReset() {
            if (!confirm('Reset entire database? This cannot be undone.')) return;

            const result = await api('POST', '/reset');
            if (result.ok) {
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                known.delegations = [];
                known.capLabels = [];
                clearLog();
                log('Database reset complete', 'success');
                renderAll();
                checkConnection();
            }
        }

        async function doCreateEntity() {
            const actor = document.getElementById('entity-actor').value.trim();
            const entityType = document.getElementById('entity-type').value;
            const id = document.getElementById('entity-id').value.trim();

            if (!actor || !id) return alert('Fill all fields');

            const result = await api('POST', '/entity', {
                actor,
                entity_type: entityType,
                id
            });

            if (result.ok) {
                known.entities.push({ id: `${entityType}:${id}`, type: entityType });
                document.getElementById('entity-id').value = '';
                renderEntities();
                renderTestSelects();
            }
        }

        async function doCreateGrant() {
            const actor = document.getElementById('grant-actor').value.trim();
            const seeker = document.getElementById('grant-seeker').value.trim();
            const relation = document.getElementById('grant-relation').value.trim();
            const scope = document.getElementById('grant-scope').value.trim();

            if (!actor || !seeker || !relation || !scope) return alert('Fill all fields');

            const result = await api('POST', '/grant', { actor, seeker, relation, scope });

            if (result.ok) {
                known.grants.push({ seeker, relation, scope });
                document.getElementById('grant-seeker').value = '';
                document.getElementById('grant-relation').value = '';
                document.getElementById('grant-scope').value = '';
                renderGrants();
            }
        }

        async function doCreateDelegation() {
            const actor = document.getElementById('deleg-actor').value.trim();
            const seeker = document.getElementById('deleg-seeker').value.trim();
            const scope = document.getElementById('deleg-scope').value.trim();
            const delegate = document.getElementById('deleg-source').value.trim();

            if (!actor || !seeker || !scope || !delegate) return alert('Fill all fields');

            // Delegation uses the inheritance API
            const result = await api('POST', '/delegation', { actor, seeker, scope, delegate });

            if (result.ok) {
                known.delegations.push({ seeker, scope, delegate });
                document.getElementById('deleg-seeker').value = '';
                document.getElementById('deleg-scope').value = '';
                document.getElementById('deleg-source').value = '';
                renderDelegations();
            }
        }

        // Bit selector state
        let selectedBits = 0;

        function initBitSelector() {
            const container = document.getElementById('bit-selector');
            container.innerHTML = '';
            // Show first 16 bits (expandable)
            for (let i = 0; i < 16; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'bit-btn';
                btn.dataset.bit = i;
                btn.textContent = i;
                btn.style.cssText = 'padding: 0.25rem; font-size: 0.65rem; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-muted); border-radius: 4px; cursor: pointer;';
                btn.onclick = () => toggleBit(i);
                container.appendChild(btn);
            }
            updateBitDisplay();
        }

        function toggleBit(bit) {
            selectedBits ^= (1 << bit);
            updateBitDisplay();
        }

        function updateBitDisplay() {
            document.querySelectorAll('.bit-btn').forEach(btn => {
                const bit = parseInt(btn.dataset.bit);
                const isSet = (selectedBits & (1 << bit)) !== 0;
                btn.style.background = isSet ? 'var(--primary)' : 'var(--bg-input)';
                btn.style.color = isSet ? 'white' : 'var(--text-muted)';
            });
            document.getElementById('cap-value').textContent = '0x' + selectedBits.toString(16).padStart(4, '0');
            document.getElementById('cap-mask-input').value = '0x' + selectedBits.toString(16).padStart(4, '0');
        }

        function parseAndSetBits(str) {
            str = str.trim().toLowerCase();
            let val = str.startsWith('0x') ? parseInt(str, 16) : parseInt(str, 10);
            if (!isNaN(val) && val >= 0) {
                selectedBits = val;
                updateBitDisplay();
            }
        }

        async function doCreateCapability() {
            const actor = document.getElementById('cap-actor').value.trim();
            const scope = document.getElementById('cap-scope').value.trim();
            const relation = document.getElementById('cap-relation').value.trim();
            const capMask = selectedBits;

            if (!actor || !scope || !relation) return alert('Fill all fields');
            if (capMask === 0) return alert('Select at least one capability bit');

            const result = await api('POST', '/capability', {
                actor,
                scope,
                relation,
                cap_mask: capMask
            });

            if (result.ok) {
                known.capabilities.push({ scope, relation, cap_mask: capMask });
                document.getElementById('cap-scope').value = '';
                document.getElementById('cap-relation').value = '';
                selectedBits = 0;
                updateBitDisplay();
                renderCapabilities();
                renderPrimitiveCapabilities();
                renderTestSelects();
            }
        }

        async function doDefineCapLabel() {
            const scope = document.getElementById('label-scope').value.trim();
            const bit = parseInt(document.getElementById('label-bit').value);
            const label = document.getElementById('label-name').value.trim();

            if (!scope || !label) return alert('Fill scope and label');
            if (isNaN(bit) || bit < 0 || bit > 15) return alert('Bit must be 0-15');

            // Call API to persist the label
            const result = await api('POST', '/cap-label', { scope, bit, label });

            if (result.ok) {
                // Update local state
                const existing = known.capLabels.findIndex(l => l.scope === scope && l.bit === bit);
                if (existing >= 0) {
                    known.capLabels[existing].label = label;
                } else {
                    known.capLabels.push({ scope, bit, label });
                }

                // Clear form
                document.getElementById('label-name').value = '';
                renderPrimitiveCapabilities();
            }
        }

        async function doCheckAccess() {
            const subject = document.getElementById('check-subject').value.trim();
            const object = document.getElementById('check-object').value.trim();
            const required = parseInt(document.getElementById('check-cap').value);

            if (!subject || !object) return alert('Fill subject and object');

            const result = await api('POST', '/check', { subject, object, required });

            const resultDiv = document.getElementById('check-result');
            if (result.ok) {
                const { allowed, effective, effective_string, required_string } = result.data;
                resultDiv.className = `result ${allowed ? 'allowed' : 'denied'}`;
                resultDiv.innerHTML = `
                    <div class="result-icon">${allowed ? '‚úì' : '‚úó'}</div>
                    <div class="result-text">${allowed ? 'ACCESS ALLOWED' : 'ACCESS DENIED'}</div>
                    <div class="result-detail">
                        Required: 0x${required.toString(16).padStart(4, '0')} (${required_string})<br>
                        Effective: 0x${effective.toString(16).padStart(4, '0')} (${effective_string})
                    </div>
                `;
            } else {
                resultDiv.className = 'result denied';
                resultDiv.innerHTML = `
                    <div class="result-icon">‚ö†</div>
                    <div class="result-text">ERROR</div>
                    <div class="result-detail">${result.error}</div>
                `;
            }
        }

        function showQueryMode(mode) {
            // Update segmented control buttons
            document.querySelectorAll('.seg-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide query sections
            document.getElementById('query-check').classList.toggle('hidden', mode !== 'check');
            document.getElementById('query-accessible').classList.toggle('hidden', mode !== 'accessible');
            document.getElementById('query-subjects').classList.toggle('hidden', mode !== 'subjects');
        }

        async function doQueryAccessible() {
            const subject = document.getElementById('query-subject').value;
            if (!subject) return alert('Select a subject');

            const result = await api('POST', '/query/accessible', { subject });
            const resultDiv = document.getElementById('accessible-result');

            if (result.ok) {
                if (result.data.length === 0) {
                    resultDiv.innerHTML = '<div class="empty" style="margin-top: 1rem;"><p>No access found</p></div>';
                    return;
                }
                resultDiv.innerHTML = `
                    <div class="list" style="margin-top: 1rem;">
                        ${result.data.map(e => {
                            const entityType = e.entity.split(':')[0];
                            return `
                                <div class="list-item">
                                    <span class="chip ${entityType}"><span class="type">${entityType}:</span>${e.entity.split(':')[1]}</span>
                                    <span class="relation-badge">${e.relation}</span>
                                    <span class="cap-badge">0x${e.effective.toString(16).padStart(4, '0')}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="result denied"><div class="result-detail">${result.error}</div></div>`;
            }
        }

        async function doQuerySubjects() {
            const object = document.getElementById('query-object').value;
            if (!object) return alert('Select an object');

            const result = await api('POST', '/query/subjects', { object });
            const resultDiv = document.getElementById('subjects-result');

            if (result.ok) {
                if (result.data.length === 0) {
                    resultDiv.innerHTML = '<div class="empty" style="margin-top: 1rem;"><p>No subjects have access</p></div>';
                    return;
                }
                resultDiv.innerHTML = `
                    <div class="list" style="margin-top: 1rem;">
                        ${result.data.map(e => {
                            const entityType = e.entity.split(':')[0];
                            return `
                                <div class="list-item">
                                    <span class="chip ${entityType}"><span class="type">${entityType}:</span>${e.entity.split(':')[1]}</span>
                                    <span class="relation-badge">${e.relation}</span>
                                    <span class="cap-badge">0x${e.effective.toString(16).padStart(4, '0')}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="result denied"><div class="result-detail">${result.error}</div></div>`;
            }
        }

        // ============================================================================
        // Templates
        // ============================================================================

        async function runTemplate(name) {
            // Check if already bootstrapped
            const status = await api('GET', '/status');
            if (status.ok && status.data.bootstrapped) {
                if (!confirm(`System is already bootstrapped (root: ${status.data.root_entity}).\n\nReset database and run "${name}" template?`)) {
                    return;
                }
                // Reset first
                log('Resetting database...', 'info');
                await api('POST', '/reset');
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                known.delegations = [];
                known.capLabels = [];
            } else {
                if (!confirm(`Run "${name}" template? This will create entities, grants, and capabilities.`)) return;
            }

            log(`--- Running template: ${name} ---`, 'info');

            if (name === 'startup') {
                // Bootstrap - root automatically gets SYSTEM_READ via admin on _type:_type
                await api('POST', '/bootstrap', { root_id: 'root' });
                known.entities.push({ id: 'user:root', type: 'user' });
                // Track that root has admin on _type:* (these are created by bootstrap)
                known.entities.push({ id: '_type:_type', type: '_type' });
                known.entities.push({ id: '_type:user', type: '_type' });
                known.entities.push({ id: '_type:team', type: '_type' });
                known.entities.push({ id: '_type:app', type: '_type' });
                known.entities.push({ id: '_type:resource', type: '_type' });
                known.grants.push({ seeker: 'user:root', relation: 'admin', scope: '_type:_type' });
                known.grants.push({ seeker: 'user:root', relation: 'admin', scope: '_type:user' });
                known.grants.push({ seeker: 'user:root', relation: 'admin', scope: '_type:team' });
                known.grants.push({ seeker: 'user:root', relation: 'admin', scope: '_type:app' });
                known.grants.push({ seeker: 'user:root', relation: 'admin', scope: '_type:resource' });
                // Bootstrap creates admin capability on each type entity
                known.capabilities.push({ scope: '_type:_type', relation: 'admin', cap_mask: 0x3FFF }); // TYPE_ADMIN
                known.capabilities.push({ scope: '_type:user', relation: 'admin', cap_mask: 0x1FFC }); // ENTITY_ADMIN
                known.capabilities.push({ scope: '_type:team', relation: 'admin', cap_mask: 0x1FFC });
                known.capabilities.push({ scope: '_type:app', relation: 'admin', cap_mask: 0x1FFC });
                known.capabilities.push({ scope: '_type:resource', relation: 'admin', cap_mask: 0x1FFC });

                // Define SystemCap bits on _type:_type (persisted to server)
                const systemBits = [
                    { bit: 0, label: 'type-create' },
                    { bit: 1, label: 'type-delete' },
                    { bit: 2, label: 'entity-create' },
                    { bit: 3, label: 'entity-delete' },
                    { bit: 4, label: 'grant-read' },
                    { bit: 5, label: 'grant-write' },
                    { bit: 6, label: 'grant-delete' },
                    { bit: 7, label: 'cap-read' },
                    { bit: 8, label: 'cap-write' },
                    { bit: 9, label: 'cap-delete' },
                    { bit: 10, label: 'delegate-read' },
                    { bit: 11, label: 'delegate-write' },
                    { bit: 12, label: 'delegate-delete' },
                    { bit: 13, label: 'system-read' },
                ];
                for (const b of systemBits) {
                    await api('POST', '/cap-label', { scope: '_type:_type', bit: b.bit, label: b.label });
                    known.capLabels.push({ scope: '_type:_type', bit: b.bit, label: b.label });
                }
                await sleep(50);

                // Create users
                for (const u of ['alice', 'bob', 'charlie']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create an office with equipment
                await api('POST', '/entity', { actor: 'user:root', entity_type: 'resource', id: 'hq-office' });
                known.entities.push({ id: 'resource:hq-office', type: 'resource' });
                await sleep(50);

                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 1: Define CAPABILITY BITS (on entity TYPE)', 'info');
                log('        These define what each bit means for all resources', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Define capability bit labels at the TYPE level
                const capBits = [
                    { bit: 0, label: 'enter' },
                    { bit: 1, label: 'print' },
                    { bit: 2, label: 'fax' },
                    { bit: 3, label: 'safe' },
                    { bit: 4, label: 'server' },
                    { bit: 5, label: 'can-grant' },
                ];

                log('  _type:resource capability bits:', 'info');
                for (const p of capBits) {
                    log(`    bit${p.bit} = ${p.label} (0x${(1 << p.bit).toString(16).padStart(2, '0')})`, 'info');
                    await api('POST', '/cap-label', { scope: '_type:resource', bit: p.bit, label: p.label });
                    known.capLabels.push({ scope: '_type:resource', bit: p.bit, label: p.label });
                }

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 2: Define GRANT RELATIONS (on entity INSTANCE)', 'info');
                log('        These define what each relation grants on hq-office', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Grant relations - defined on the entity instance
                const grantRelations = [
                    { relation: 'visitor',  cap: 0x01, desc: 'enter only' },
                    { relation: 'employee', cap: 0x07, desc: 'enter + print + fax' },
                    { relation: 'manager',  cap: 0x0F, desc: 'enter + print + fax + safe' },
                    { relation: 'owner',    cap: 0x3F, desc: 'all actions' },
                ];

                log('  resource:hq-office grant relations:', 'info');
                for (const c of grantRelations) {
                    log(`    "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', {
                        actor: 'user:root',
                        scope: 'resource:hq-office',
                        relation: c.relation,
                        cap_mask: c.cap
                    });
                    known.capabilities.push({ scope: 'resource:hq-office', relation: c.relation, cap_mask: c.cap });
                    await sleep(50);
                }

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 3: Create GRANTS (assign capability sets to users)', 'info');
                log('        Each grant gives a user a role on a scope', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // GRANTS assign roles (sets of capabilities) to seekers
                // One grant = one role = multiple primitive actions
                const grants = [
                    // Alice gets owner role (all actions in one grant)
                    { actor: 'user:root', seeker: 'user:alice', relation: 'owner', scope: 'resource:hq-office' },
                    // Bob gets employee role (enter + print + fax in one grant)
                    { actor: 'user:root', seeker: 'user:bob', relation: 'employee', scope: 'resource:hq-office' },
                    // Charlie gets visitor role (enter only in one grant)
                    { actor: 'user:alice', seeker: 'user:charlie', relation: 'visitor', scope: 'resource:hq-office' },
                ];

                for (const g of grants) {
                    log(`  Grant: ${g.seeker} -> "${g.relation}" on ${g.scope}`, 'info');
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                    await sleep(50);
                }

                // Create a new user for delegation demo
                await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: 'dana' });
                known.entities.push({ id: 'user:dana', type: 'user' });
                await sleep(50);

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 4: Create DELEGATION (inherited grants)', 'info');
                log('        Dana inherits Alice\'s role on hq-office', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Add delegator capability (owner already has can-grant bit, but we need DELEGATE_WRITE for the API)
                await api('POST', '/capability', {
                    actor: 'user:root',
                    scope: 'resource:hq-office',
                    relation: 'delegator',
                    cap_mask: 0x0800  // DELEGATE_WRITE
                });
                known.capabilities.push({ scope: 'resource:hq-office', relation: 'delegator', cap_mask: 0x0800 });

                await api('POST', '/grant', {
                    actor: 'user:root',
                    seeker: 'user:alice',
                    relation: 'delegator',
                    scope: 'resource:hq-office'
                });
                known.grants.push({ seeker: 'user:alice', relation: 'delegator', scope: 'resource:hq-office' });
                await sleep(50);

                // Alice delegates to dana - dana inherits alice's owner role
                log('  Delegation: dana inherits from alice on hq-office', 'info');
                await api('POST', '/delegation', {
                    actor: 'user:alice',
                    seeker: 'user:dana',
                    scope: 'resource:hq-office',
                    delegate: 'user:alice'
                });
                known.delegations.push({ seeker: 'user:dana', scope: 'resource:hq-office', delegate: 'user:alice' });
                await sleep(50);

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('SUMMARY:', 'info');
                log('  Entities: things (users, office)', 'info');
                log('  Primitive Caps: individual action bits (enter, print, fax...)', 'info');
                log('  Capability Sets: roles combining primitives (visitor, employee...)', 'info');
                log('  Grants: assign a capability set to a user on a scope', 'info');
                log('  Delegations: inherit grants from another user', 'info');
                log('', 'info');
                log('EFFECTIVE PERMISSIONS:', 'info');
                log('  alice:   0x3F (owner = enter+print+fax+safe+server+can-grant)', 'info');
                log('  bob:     0x07 (employee = enter+print+fax)', 'info');
                log('  charlie: 0x01 (visitor = enter)', 'info');
                log('  dana:    0x3F (inherited owner from alice)', 'info');
                log('', 'info');
                log('TEST SUGGESTIONS:', 'info');
                log('  - bob on hq-office with 0x04 (fax) -> ALLOWED (employee has fax)', 'info');
                log('  - charlie on hq-office with 0x04 (fax) -> DENIED (visitor lacks fax)', 'info');
                log('  - dana on hq-office with 0x08 (safe) -> ALLOWED (inherited owner)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            } else if (name === 'saas') {
                // Bootstrap - admin automatically gets SYSTEM_READ via admin on _type:_type
                await api('POST', '/bootstrap', { root_id: 'admin' });
                known.entities.push({ id: 'user:admin', type: 'user' });
                // Track bootstrap-created system entities
                known.entities.push({ id: '_type:_type', type: '_type' });
                known.entities.push({ id: '_type:user', type: '_type' });
                known.entities.push({ id: '_type:team', type: '_type' });
                known.entities.push({ id: '_type:app', type: '_type' });
                known.entities.push({ id: '_type:resource', type: '_type' });
                known.grants.push({ seeker: 'user:admin', relation: 'admin', scope: '_type:_type' });
                known.grants.push({ seeker: 'user:admin', relation: 'admin', scope: '_type:user' });
                known.grants.push({ seeker: 'user:admin', relation: 'admin', scope: '_type:team' });
                known.grants.push({ seeker: 'user:admin', relation: 'admin', scope: '_type:app' });
                known.grants.push({ seeker: 'user:admin', relation: 'admin', scope: '_type:resource' });
                known.capabilities.push({ scope: '_type:_type', relation: 'admin', cap_mask: 0x3FFF });
                known.capabilities.push({ scope: '_type:user', relation: 'admin', cap_mask: 0x1FFC });
                known.capabilities.push({ scope: '_type:team', relation: 'admin', cap_mask: 0x1FFC });
                known.capabilities.push({ scope: '_type:app', relation: 'admin', cap_mask: 0x1FFC });
                known.capabilities.push({ scope: '_type:resource', relation: 'admin', cap_mask: 0x1FFC });

                // Define SystemCap bits on _type:_type (persisted to server)
                const systemBits = [
                    { bit: 0, label: 'type-create' },
                    { bit: 1, label: 'type-delete' },
                    { bit: 2, label: 'entity-create' },
                    { bit: 3, label: 'entity-delete' },
                    { bit: 4, label: 'grant-read' },
                    { bit: 5, label: 'grant-write' },
                    { bit: 6, label: 'grant-delete' },
                    { bit: 7, label: 'cap-read' },
                    { bit: 8, label: 'cap-write' },
                    { bit: 9, label: 'cap-delete' },
                    { bit: 10, label: 'delegate-read' },
                    { bit: 11, label: 'delegate-write' },
                    { bit: 12, label: 'delegate-delete' },
                    { bit: 13, label: 'system-read' },
                ];
                for (const b of systemBits) {
                    await api('POST', '/cap-label', { scope: '_type:_type', bit: b.bit, label: b.label });
                    known.capLabels.push({ scope: '_type:_type', bit: b.bit, label: b.label });
                }
                await sleep(50);

                // Create tenant orgs
                for (const t of ['acme', 'globex']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(50);
                }

                // Create users
                for (const u of ['alice', 'bob', 'charlie', 'dana']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create apps/services
                for (const a of ['api-gateway', 'dashboard', 'analytics']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'app', id: a });
                    if (r.ok) known.entities.push({ id: `app:${a}`, type: 'app' });
                    await sleep(50);
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 1: Define CAPABILITY BITS (on entity TYPES)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 1: Define CAPABILITY BITS (on entity TYPES)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // App type capability bits
                log('  _type:app capability bits:', 'info');
                const appBits = [
                    { bit: 0, label: 'read' },
                    { bit: 1, label: 'write' },
                    { bit: 2, label: 'delete' },
                    { bit: 3, label: 'bulk' },
                    { bit: 4, label: 'webhooks' },
                    { bit: 5, label: 'export' },
                    { bit: 6, label: 'admin' },
                    { bit: 7, label: 'unlimited' },
                ];
                for (const p of appBits) {
                    log(`    bit${p.bit} = ${p.label}`, 'info');
                    await api('POST', '/cap-label', { scope: '_type:app', bit: p.bit, label: p.label });
                    known.capLabels.push({ scope: '_type:app', bit: p.bit, label: p.label });
                }

                // Team type capability bits
                log('  _type:team capability bits:', 'info');
                const teamBits = [
                    { bit: 0, label: 'view-org' },
                    { bit: 1, label: 'invite' },
                    { bit: 2, label: 'billing' },
                    { bit: 3, label: 'settings' },
                ];
                for (const p of teamBits) {
                    log(`    bit${p.bit} = ${p.label}`, 'info');
                    await api('POST', '/cap-label', { scope: '_type:team', bit: p.bit, label: p.label });
                    known.capLabels.push({ scope: '_type:team', bit: p.bit, label: p.label });
                }
                await sleep(50);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 2: Define GRANT RELATIONS (on entity INSTANCES)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 2: Define GRANT RELATIONS (on entity INSTANCES)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                log('  app:api-gateway grant relations:', 'info');
                const apiCaps = [
                    { relation: 'basic',      cap: 0x03, desc: 'read + write' },
                    { relation: 'pro',        cap: 0x1F, desc: 'read + write + delete + bulk + webhooks' },
                    { relation: 'enterprise', cap: 0xFF, desc: 'all actions' },
                ];
                for (const c of apiCaps) {
                    log(`    "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', { actor: 'user:admin', scope: 'app:api-gateway', relation: c.relation, cap_mask: c.cap });
                    known.capabilities.push({ scope: 'app:api-gateway', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                log('  app:dashboard grant relations:', 'info');
                const dashCaps = [
                    { relation: 'viewer',   cap: 0x01, desc: 'view only' },
                    { relation: 'analyst',  cap: 0x07, desc: 'view + create + share' },
                    { relation: 'manager',  cap: 0x0F, desc: 'all actions' },
                ];
                for (const c of dashCaps) {
                    log(`    "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', { actor: 'user:admin', scope: 'app:dashboard', relation: c.relation, cap_mask: c.cap });
                    known.capabilities.push({ scope: 'app:dashboard', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                log('  team:acme, team:globex grant relations:', 'info');
                const tenantCaps = [
                    { relation: 'member', cap: 0x01, desc: 'view only' },
                    { relation: 'admin',  cap: 0x03, desc: 'view + invite' },
                    { relation: 'owner',  cap: 0x0F, desc: 'all actions' },
                ];
                for (const tenant of ['acme', 'globex']) {
                    for (const c of tenantCaps) {
                        await api('POST', '/capability', { actor: 'user:admin', scope: `team:${tenant}`, relation: c.relation, cap_mask: c.cap });
                        known.capabilities.push({ scope: `team:${tenant}`, relation: c.relation, cap_mask: c.cap });
                    }
                }
                await sleep(50);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 3: Create GRANTS (assign relations to users)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 3: Create GRANTS (assign relations to users)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Each grant assigns a relation to a user on an entity
                const grants = [
                    // Alice: enterprise on api-gateway (0xFF = all actions)
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'enterprise', scope: 'app:api-gateway' },
                    // Alice: manager on dashboard (0x0F = all actions)
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'manager', scope: 'app:dashboard' },
                    // Alice: owner of team:acme (0x0F = all actions)
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'owner', scope: 'team:acme' },

                    // Bob: pro on api-gateway (0x1F = read+write+delete+bulk+webhooks)
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'pro', scope: 'app:api-gateway' },
                    // Bob: analyst on dashboard (0x07 = view+create+share)
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'analyst', scope: 'app:dashboard' },
                    // Bob: member of acme (0x01 = view only)
                    { actor: 'user:alice', seeker: 'user:bob', relation: 'member', scope: 'team:acme' },

                    // Charlie: basic on api (0x03 = read+write)
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'basic', scope: 'app:api-gateway' },
                    // Charlie: viewer on dashboard (0x01 = view only)
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'viewer', scope: 'app:dashboard' },
                    // Charlie: owner of globex (0x0F = all actions)
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'owner', scope: 'team:globex' },

                    // Dana: member of globex (0x01 = view only)
                    { actor: 'user:charlie', seeker: 'user:dana', relation: 'member', scope: 'team:globex' },
                ];

                for (const g of grants) {
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                }
                log(`  Created ${grants.length} grants`, 'info');
                await sleep(50);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 4: Create DELEGATION (inherited grants)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 4: Create DELEGATION', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Create contractor
                await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: 'contractor' });
                known.entities.push({ id: 'user:contractor', type: 'user' });

                // Add delegate capability
                await api('POST', '/capability', { actor: 'user:admin', scope: 'app:api-gateway', relation: 'delegate', cap_mask: 0x0800 });
                known.capabilities.push({ scope: 'app:api-gateway', relation: 'delegate', cap_mask: 0x0800 });
                await api('POST', '/grant', { actor: 'user:admin', seeker: 'user:alice', relation: 'delegate', scope: 'app:api-gateway' });
                known.grants.push({ seeker: 'user:alice', relation: 'delegate', scope: 'app:api-gateway' });

                // Alice delegates to contractor
                log('  Delegation: contractor inherits from alice on api-gateway', 'info');
                await api('POST', '/delegation', { actor: 'user:alice', seeker: 'user:contractor', scope: 'app:api-gateway', delegate: 'user:alice' });
                known.delegations.push({ seeker: 'user:contractor', scope: 'app:api-gateway', delegate: 'user:alice' });

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('SUMMARY:', 'info');
                log('  Entities = things (users, apps, teams)', 'info');
                log('  Primitive Capabilities = individual action bits', 'info');
                log('  Capability Sets = roles combining primitives', 'info');
                log('  Grants = assign a capability set to a user on a scope', 'info');
                log('', 'info');
                log('CAPABILITY SETS GRANTED:', 'info');
                log('  alice:      enterprise (api), manager (dash), owner (acme)', 'info');
                log('  bob:        pro (api), analyst (dash), member (acme)', 'info');
                log('  charlie:    basic (api), viewer (dash), owner (globex)', 'info');
                log('  dana:       member (globex)', 'info');
                log('  contractor: inherits enterprise from alice', 'info');
                log('', 'info');
                log('EFFECTIVE CAPABILITIES:', 'info');
                log('  alice on api: 0xFF (enterprise = all actions)', 'info');
                log('  bob on api:   0x1F (pro = read+write+delete+bulk+webhooks)', 'info');
                log('  charlie on api: 0x03 (basic = read+write)', 'info');
                log('  contractor on api: 0xFF (inherited enterprise from alice)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            }

            log(`--- Template "${name}" complete ---`, 'info');
            renderAll();
            checkConnection();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================================================
        // UI
        // ============================================================================

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const tabContent = document.getElementById(`tab-${name}`);
            if (tabContent) tabContent.classList.add('active');
            const tabBtn = document.querySelector(`.tab[onclick="showTab('${name}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
        }

        function toggleAccordion(section) {
            const content = document.getElementById(`section-${section}`);
            const arrow = document.querySelector(`.accordion[data-section="${section}"] .accordion-arrow`);
            const isOpen = content.classList.contains('open');

            content.classList.toggle('open');
            arrow.textContent = isOpen ? '‚ñ∂' : '‚ñº';
        }

        async function setViewer(viewer) {
            currentViewer = viewer;
            await updateViewerPermission();
        }

        // Check if current viewer can see system internals
        async function canViewSystem() {
            if (!connected) return false;
            try {
                const res = await fetch(`${apiUrl}/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject: currentViewer,
                        object: SYSTEM_READ_SCOPE,
                        required: SYSTEM_READ_BIT
                    })
                });
                const json = await res.json();
                return json.success && json.data && json.data.allowed;
            } catch {
                return false;
            }
        }

        // Cache for view system permission (updated on viewer change)
        let viewerCanSeeSystem = false;

        async function updateViewerPermission() {
            viewerCanSeeSystem = await canViewSystem();
            renderAll();
        }

        // Helper to filter system entities based on viewer's capability
        function filterSystem(items, scopeField = 'id') {
            if (viewerCanSeeSystem) return items;
            return items.filter(item => {
                const val = item[scopeField] || item.id || item.scope;
                return !val.startsWith('_type:') && !val.startsWith('_system:');
            });
        }

        // Check if an entity is a system internal
        function isSystemEntity(id) {
            return id.startsWith('_type:') || id.startsWith('_system:');
        }

        function renderAll() {
            renderViewerSelect();
            renderEntities();
            renderPrimitiveCapabilities();
            renderCapabilities();
            renderGrants();
            renderDelegations();
            renderTestSelects();
            updateCounts();
        }

        function updateCounts() {
            const displayEntities = filterSystem(known.entities, 'id');
            const displayCaps = filterSystem(known.capabilities, 'scope');
            const displayGrants = filterSystem(known.grants, 'scope');

            document.getElementById('count-entities').textContent = displayEntities.length;
            document.getElementById('count-capbits').textContent = known.capLabels.length;
            document.getElementById('count-relations').textContent = displayCaps.length;
            document.getElementById('count-grants').textContent = displayGrants.length;
            document.getElementById('count-delegations').textContent = known.delegations.length;

            // Update Home tab button with total count
            const total = displayEntities.length + known.capLabels.length + displayCaps.length + displayGrants.length + known.delegations.length;
            const homeBtn = document.getElementById('tab-btn-home');
            if (homeBtn) {
                homeBtn.textContent = total > 0 ? `Home (${total})` : 'Home';
            }
        }

        function renderViewerSelect() {
            const select = document.getElementById('current-viewer');
            // Show all user entities as potential viewers
            const users = known.entities.filter(e => e.type === 'user');
            if (users.length === 0) {
                select.innerHTML = '<option value="user:root">user:root</option>';
                return;
            }
            select.innerHTML = users.map(u =>
                `<option value="${u.id}" ${u.id === currentViewer ? 'selected' : ''}>${u.id}</option>`
            ).join('');
        }

        function renderTestSelects() {
            const subjectSelect = document.getElementById('check-subject');
            const objectSelect = document.getElementById('check-object');
            const capSelect = document.getElementById('check-cap');
            const querySubjectSelect = document.getElementById('query-subject');
            const queryObjectSelect = document.getElementById('query-object');

            // Filter based on toggle
            const displayEntities = filterSystem(known.entities, 'id');
            const entityOptions = displayEntities.map(e =>
                `<option value="${e.id}">${e.id}</option>`
            ).join('');

            const placeholder = '<option value="">-- Select entity --</option>';
            subjectSelect.innerHTML = placeholder + entityOptions;
            objectSelect.innerHTML = placeholder + entityOptions;
            querySubjectSelect.innerHTML = placeholder + entityOptions;
            queryObjectSelect.innerHTML = placeholder + entityOptions;

            // Build capability options - show scope ‚Üí relation ‚Üí mask
            const displayCaps = filterSystem(known.capabilities, 'scope');

            // Sort by scope, then by cap_mask
            const sortedCaps = [...displayCaps].sort((a, b) => {
                if (a.scope !== b.scope) return a.scope.localeCompare(b.scope);
                return a.cap_mask - b.cap_mask;
            });

            let capOptions = '<option value="0">0x0000 (ANY)</option>';
            sortedCaps.forEach(c => {
                const hex = '0x' + c.cap_mask.toString(16).padStart(4, '0').toUpperCase();
                capOptions += `<option value="${c.cap_mask}">${c.scope} ‚Üí ${c.relation} (${hex})</option>`;
            });

            capSelect.innerHTML = capOptions;
        }

        function renderEntities() {
            const list = document.getElementById('entity-list');
            const displayEntities = filterSystem(known.entities, 'id');
            if (displayEntities.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No entities yet</p></div>';
                return;
            }
            list.innerHTML = displayEntities.map(e => {
                const isSystem = isSystemEntity(e.id);
                const icon = isSystem ? '<span title="System internal" style="opacity: 0.6; margin-right: 0.25rem;">‚öô</span>' : '';
                const style = isSystem ? 'opacity: 0.7;' : '';
                return `
                    <div class="list-item" style="${style}">
                        ${icon}<span class="chip ${e.type}"><span class="type">${e.type}:</span>${e.id.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderPrimitiveCapabilities() {
            const container = document.getElementById('primitive-cap-list');

            if (known.capLabels.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üîπ</div><p>No primitive capabilities defined yet</p></div>';
                return;
            }

            // Group by scope, sort by bit
            const byScope = new Map();
            known.capLabels.forEach(l => {
                if (!byScope.has(l.scope)) {
                    byScope.set(l.scope, []);
                }
                byScope.get(l.scope).push(l);
            });

            let html = '<div class="list">';
            byScope.forEach((labels, scope) => {
                labels.sort((a, b) => a.bit - b.bit);
                const scopeType = scope.split(':')[0];
                labels.forEach(l => {
                    const mask = 1 << l.bit;
                    html += `
                        <div class="list-item">
                            <span class="chip ${scopeType}" style="min-width: 120px;"><span class="type">${scopeType}:</span>${scope.split(':')[1]}</span>
                            <span class="cap-badge" style="background: var(--success); color: white;">bit${l.bit}</span>
                            <span style="font-weight: 600;">${l.label}</span>
                            <span class="cap-badge">0x${mask.toString(16).padStart(4, '0')}</span>
                        </div>
                    `;
                });
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderGrants() {
            const list = document.getElementById('grant-list');
            const displayGrants = filterSystem(known.grants, 'scope');
            if (displayGrants.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">üîó</div><p>No direct grants yet</p></div>';
                return;
            }
            list.innerHTML = displayGrants.map(g => {
                const seekerType = g.seeker.split(':')[0];
                const scopeType = g.scope.split(':')[0];
                const isSystem = isSystemEntity(g.scope);
                const icon = isSystem ? '<span title="System internal" style="opacity: 0.6; margin-right: 0.25rem;">‚öô</span>' : '';
                const style = isSystem ? 'opacity: 0.7;' : '';
                return `
                    <div class="list-item" style="${style}">
                        ${icon}<span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${g.seeker.split(':')[1]}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="relation-badge">${g.relation}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${g.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderDelegations() {
            const list = document.getElementById('delegation-list');
            if (known.delegations.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">‚ÜóÔ∏è</div><p>No delegations yet</p></div>';
                return;
            }
            list.innerHTML = known.delegations.map(d => {
                const seekerType = d.seeker.split(':')[0];
                const delegateType = d.delegate.split(':')[0];
                const scopeType = d.scope.split(':')[0];
                return `
                    <div class="list-item" style="background: rgba(245, 158, 11, 0.1);">
                        <span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${d.seeker.split(':')[1]}</span>
                        <span class="arrow" style="color: var(--warning);">inherits from</span>
                        <span class="chip ${delegateType}"><span class="type">${delegateType}:</span>${d.delegate.split(':')[1]}</span>
                        <span class="arrow">on</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${d.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderCapabilities() {
            const list = document.getElementById('cap-list');
            const displayCaps = filterSystem(known.capabilities, 'scope');
            if (displayCaps.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">‚ö°</div><p>No grant relations defined yet</p></div>';
                return;
            }
            list.innerHTML = displayCaps.map(c => {
                const scopeType = c.scope.split(':')[0];
                const typeScope = `_type:${scopeType}`;
                const isSystem = isSystemEntity(c.scope);
                const icon = isSystem ? '<span title="System internal" style="opacity: 0.6; margin-right: 0.25rem;">‚öô</span>' : '';
                const style = isSystem ? 'opacity: 0.7;' : '';

                // Get labels from TYPE level (e.g., _type:resource for resource:hq-office)
                const typeLabels = known.capLabels.filter(l => l.scope === typeScope);
                const bitLabels = [];
                for (let i = 0; i < 16; i++) {
                    if (c.cap_mask & (1 << i)) {
                        const label = typeLabels.find(l => l.bit === i);
                        bitLabels.push(label ? label.label : `bit${i}`);
                    }
                }
                const labelStr = bitLabels.length > 0 ? bitLabels.join(' + ') : '';

                return `
                    <div class="list-item" style="flex-wrap: wrap; ${style}">
                        ${icon}<span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${c.scope.split(':')[1]}</span>
                        <span class="relation-badge">${c.relation}</span>
                        <span class="cap-badge">0x${c.cap_mask.toString(16).padStart(4, '0')}</span>
                        ${labelStr ? `<span style="font-size: 0.7rem; color: var(--text-muted); width: 100%; margin-top: 0.25rem;">= ${labelStr}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Init
        initBitSelector();

        // Auto-connect on load
        checkConnection();
    </script>
</body>
</html>
