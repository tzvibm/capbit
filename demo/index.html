<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capbit Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }

        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
        }

        h1 { font-size: 1.5rem; font-weight: 700; }
        h1 span { color: var(--primary); }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected { background: var(--success); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-row.stack { flex-direction: column; }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        select, input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.625rem;
            color: var(--text);
            font-size: 0.875rem;
            width: 100%;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        .btn.danger { background: var(--danger); }
        .btn.success { background: var(--success); }
        .btn.warning { background: var(--warning); }
        .btn.outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn.full { width: 100%; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-group .btn { flex: 1; }

        /* Log */
        .log {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.7rem;
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
            word-break: break-all;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--primary); }
        .log-entry.request { color: var(--warning); }
        .log-entry .time { color: var(--text-muted); margin-right: 0.5rem; }
        .log-entry .method {
            background: var(--bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }

        /* Result box */
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .result.allowed { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); }
        .result.denied { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); }

        .result-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .result-text { font-weight: 600; font-size: 1rem; }
        .result-detail { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-input);
            border-radius: 6px;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .chip .type { color: var(--primary); font-weight: 600; }
        .chip.user .type { color: #22c55e; }
        .chip.team .type { color: #f59e0b; }
        .chip.app .type { color: #ec4899; }
        .chip.resource .type { color: #06b6d4; }

        /* Lists */
        .list { display: flex; flex-direction: column; gap: 0.5rem; }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8125rem;
            flex-wrap: wrap;
        }

        .list-item .arrow { color: var(--text-muted); }

        .relation-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .cap-badge {
            font-family: monospace;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Config panel */
        .config-panel {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-row input {
            flex: 1;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <h1>Cap<span>bit</span></h1>
        <div class="status-bar">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </header>

    <div class="container">
        <!-- Server Config -->
        <div class="card">
            <div class="card-title">Server Connection</div>
            <div class="config-row">
                <input type="text" id="api-url" value="http://localhost:3000" placeholder="API URL">
                <button class="btn sm" onclick="checkConnection()">Connect</button>
            </div>
        </div>

        <!-- Activity Log - Always visible -->
        <div class="card">
            <div class="card-title">
                Activity Log
                <button class="btn sm outline" onclick="clearLog()">Clear</button>
            </div>
            <div class="log" id="log"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">Setup</button>
            <button class="tab" onclick="showTab('entities')">Entities</button>
            <button class="tab" onclick="showTab('grants')">Grants</button>
            <button class="tab" onclick="showTab('caps')">Caps</button>
            <button class="tab" onclick="showTab('test')">Test</button>
        </div>

        <!-- Setup Tab -->
        <div id="tab-setup" class="tab-content active">
            <div class="card">
                <div class="card-title">Bootstrap System</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Root User ID</label>
                        <input type="text" id="bootstrap-root" value="root" placeholder="e.g. root, admin">
                    </div>
                </div>
                <button class="btn full" onclick="doBootstrap()">Bootstrap</button>
            </div>

            <div class="card">
                <div class="card-title">Quick Setup Templates</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Run a template to populate the system. Watch the log to see each API call.
                </p>
                <div class="btn-group">
                    <button class="btn warning" onclick="runTemplate('startup')">Startup</button>
                    <button class="btn warning" onclick="runTemplate('saas')">SaaS</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Danger Zone</div>
                <button class="btn danger full" onclick="doReset()">Reset Database</button>
            </div>
        </div>

        <!-- Entities Tab -->
        <div id="tab-entities" class="tab-content">
            <div class="card">
                <div class="card-title">Create Entity</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type</label>
                        <select id="entity-type">
                            <option value="user">user</option>
                            <option value="team">team</option>
                            <option value="app">app</option>
                            <option value="resource">resource</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ID</label>
                        <input type="text" id="entity-id" placeholder="e.g. alice, engineering">
                    </div>
                </div>
                <div class="input-group">
                    <label>Actor (who's creating)</label>
                    <input type="text" id="entity-actor" value="user:root" placeholder="e.g. user:root">
                </div>
                <button class="btn full" onclick="doCreateEntity()">Create Entity</button>
            </div>

            <div class="card">
                <div class="card-title">Known Entities</div>
                <div class="list" id="entity-list">
                    <div class="empty">
                        <div class="empty-icon">ðŸ“‹</div>
                        <p>Entities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grants Tab -->
        <div id="tab-grants" class="tab-content">
            <div class="card">
                <div class="card-title">Create Grant</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's granting - must have GRANT_WRITE)</label>
                        <input type="text" id="grant-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="input-group">
                        <label>Seeker (who receives the grant)</label>
                        <input type="text" id="grant-seeker" placeholder="e.g. user:alice">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="grant-relation" placeholder="e.g. lead, member, editor">
                        </div>
                        <div class="input-group">
                            <label>Scope (on what)</label>
                            <input type="text" id="grant-scope" placeholder="e.g. team:engineering">
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateGrant()">Create Grant</button>
            </div>

            <div class="card">
                <div class="card-title">Known Grants</div>
                <div class="list" id="grant-list">
                    <div class="empty">
                        <div class="empty-icon">ðŸ”—</div>
                        <p>Grants tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capabilities Tab -->
        <div id="tab-caps" class="tab-content">
            <div class="card">
                <div class="card-title">Define Capability</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's defining - must have CAP_WRITE)</label>
                        <input type="text" id="cap-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Scope (on what entity)</label>
                            <input type="text" id="cap-scope" placeholder="e.g. team:engineering">
                        </div>
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="cap-relation" placeholder="e.g. lead, member">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Capability Bits</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="16"> READ (0x10)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="32"> WRITE (0x20)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="64"> DELETE (0x40)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="4"> CREATE (0x04)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="256"> CAP_WRITE (0x100)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;">
                                <input type="checkbox" class="cap-bit" value="2048"> DELEGATE (0x800)
                            </label>
                        </div>
                        <div style="margin-top: 0.5rem; font-family: monospace; font-size: 0.75rem; color: var(--text-muted);">
                            Selected: <span id="cap-value">0x0000</span> (<span id="cap-decimal">0</span>)
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateCapability()">Define Capability</button>
            </div>

            <div class="card">
                <div class="card-title">Known Capabilities</div>
                <div class="list" id="cap-list">
                    <div class="empty">
                        <div class="empty-icon">âš¡</div>
                        <p>Capabilities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="tab-test" class="tab-content">
            <div class="card">
                <div class="card-title">Check Permission</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Subject (who's asking)</label>
                        <input type="text" id="check-subject" placeholder="e.g. user:alice">
                    </div>
                    <div class="input-group">
                        <label>Object (accessing what)</label>
                        <input type="text" id="check-object" placeholder="e.g. team:engineering">
                    </div>
                    <div class="input-group">
                        <label>Required Capability</label>
                        <select id="check-cap">
                            <option value="16">GRANT_READ (0x0010)</option>
                            <option value="32">GRANT_WRITE (0x0020)</option>
                            <option value="64">GRANT_DELETE (0x0040)</option>
                            <option value="4">ENTITY_CREATE (0x0004)</option>
                            <option value="256">CAP_WRITE (0x0100)</option>
                            <option value="2048">DELEGATE_WRITE (0x0800)</option>
                            <option value="48">READ+WRITE (0x0030)</option>
                            <option value="112">FULL GRANT (0x0070)</option>
                            <option value="0">ANY (0x0000)</option>
                        </select>
                    </div>
                </div>
                <button class="btn success full" onclick="doCheckAccess()">Check Access</button>
                <div id="check-result"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================

        let apiUrl = 'http://localhost:3000';
        let connected = false;

        // Client-side tracking (mirrors what we've created via API)
        const known = {
            entities: [],
            grants: [],
            capabilities: []
        };

        // ============================================================================
        // Logging
        // ============================================================================

        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">${time}</span>${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep log size reasonable
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function logRequest(method, endpoint, body = null) {
            let msg = `<span class="method">${method}</span> ${endpoint}`;
            if (body) {
                msg += ` <span style="color: var(--text-muted)">${JSON.stringify(body)}</span>`;
            }
            log(msg, 'request');
        }

        function logResponse(success, data) {
            if (success) {
                log(`âœ“ ${JSON.stringify(data)}`, 'success');
            } else {
                log(`âœ— ${data}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // ============================================================================
        // API Calls
        // ============================================================================

        async function api(method, endpoint, body = null) {
            logRequest(method, endpoint, body);

            try {
                const opts = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`${apiUrl}${endpoint}`, opts);
                const json = await res.json();

                if (json.success) {
                    logResponse(true, json.data);
                    return { ok: true, data: json.data };
                } else {
                    logResponse(false, json.error);
                    return { ok: false, error: json.error };
                }
            } catch (e) {
                logResponse(false, e.message);
                return { ok: false, error: e.message };
            }
        }

        // ============================================================================
        // Connection
        // ============================================================================

        async function checkConnection() {
            const inputUrl = document.getElementById('api-url').value.trim();
            apiUrl = inputUrl ? inputUrl.replace(/\/$/, '') : '';  // Empty = same origin
            log(`Connecting to ${apiUrl || window.location.origin}...`, 'info');

            const result = await api('GET', '/status');

            if (result.ok) {
                connected = true;
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').textContent =
                    result.data.bootstrapped
                        ? `Connected (root: ${result.data.root_entity})`
                        : 'Connected (not bootstrapped)';
            } else {
                connected = false;
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('status-text').textContent = 'Connection failed';
            }
        }

        // ============================================================================
        // Actions
        // ============================================================================

        async function doBootstrap() {
            const rootId = document.getElementById('bootstrap-root').value.trim();
            if (!rootId) return alert('Enter a root ID');

            const result = await api('POST', '/bootstrap', { root_id: rootId });
            if (result.ok) {
                known.entities.push({ id: `user:${rootId}`, type: 'user' });
                renderEntities();
                checkConnection();
            }
        }

        async function doReset() {
            if (!confirm('Reset entire database? This cannot be undone.')) return;

            const result = await api('POST', '/reset');
            if (result.ok) {
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                renderAll();
                checkConnection();
            }
        }

        async function doCreateEntity() {
            const actor = document.getElementById('entity-actor').value.trim();
            const entityType = document.getElementById('entity-type').value;
            const id = document.getElementById('entity-id').value.trim();

            if (!actor || !id) return alert('Fill all fields');

            const result = await api('POST', '/entity', {
                actor,
                entity_type: entityType,
                id
            });

            if (result.ok) {
                known.entities.push({ id: `${entityType}:${id}`, type: entityType });
                document.getElementById('entity-id').value = '';
                renderEntities();
            }
        }

        async function doCreateGrant() {
            const actor = document.getElementById('grant-actor').value.trim();
            const seeker = document.getElementById('grant-seeker').value.trim();
            const relation = document.getElementById('grant-relation').value.trim();
            const scope = document.getElementById('grant-scope').value.trim();

            if (!actor || !seeker || !relation || !scope) return alert('Fill all fields');

            const result = await api('POST', '/grant', { actor, seeker, relation, scope });

            if (result.ok) {
                known.grants.push({ seeker, relation, scope });
                document.getElementById('grant-seeker').value = '';
                document.getElementById('grant-relation').value = '';
                document.getElementById('grant-scope').value = '';
                renderGrants();
            }
        }

        async function doCreateCapability() {
            const actor = document.getElementById('cap-actor').value.trim();
            const scope = document.getElementById('cap-scope').value.trim();
            const relation = document.getElementById('cap-relation').value.trim();

            let capMask = 0;
            document.querySelectorAll('.cap-bit:checked').forEach(cb => {
                capMask |= parseInt(cb.value);
            });

            if (!actor || !scope || !relation) return alert('Fill all fields');

            const result = await api('POST', '/capability', {
                actor,
                scope,
                relation,
                cap_mask: capMask
            });

            if (result.ok) {
                known.capabilities.push({ scope, relation, cap_mask: capMask });
                document.getElementById('cap-scope').value = '';
                document.getElementById('cap-relation').value = '';
                document.querySelectorAll('.cap-bit').forEach(cb => cb.checked = false);
                updateCapValue();
                renderCapabilities();
            }
        }

        async function doCheckAccess() {
            const subject = document.getElementById('check-subject').value.trim();
            const object = document.getElementById('check-object').value.trim();
            const required = parseInt(document.getElementById('check-cap').value);

            if (!subject || !object) return alert('Fill subject and object');

            const result = await api('POST', '/check', { subject, object, required });

            const resultDiv = document.getElementById('check-result');
            if (result.ok) {
                const { allowed, effective, effective_string, required_string } = result.data;
                resultDiv.className = `result ${allowed ? 'allowed' : 'denied'}`;
                resultDiv.innerHTML = `
                    <div class="result-icon">${allowed ? 'âœ“' : 'âœ—'}</div>
                    <div class="result-text">${allowed ? 'ACCESS ALLOWED' : 'ACCESS DENIED'}</div>
                    <div class="result-detail">
                        Required: 0x${required.toString(16).padStart(4, '0')} (${required_string})<br>
                        Effective: 0x${effective.toString(16).padStart(4, '0')} (${effective_string})
                    </div>
                `;
            } else {
                resultDiv.className = 'result denied';
                resultDiv.innerHTML = `
                    <div class="result-icon">âš </div>
                    <div class="result-text">ERROR</div>
                    <div class="result-detail">${result.error}</div>
                `;
            }
        }

        // ============================================================================
        // Templates
        // ============================================================================

        async function runTemplate(name) {
            if (!confirm(`Run "${name}" template? This will create entities, grants, and capabilities.`)) return;

            log(`--- Running template: ${name} ---`, 'info');

            if (name === 'startup') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'root' });
                known.entities.push({ id: 'user:root', type: 'user' });

                // Create teams
                for (const t of ['engineering', 'sales', 'hr']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(100);
                }

                // Create users
                for (const u of ['alice', 'bob', 'charlie', 'dave', 'eve']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(100);
                }

                // Define team capabilities
                for (const t of ['engineering', 'sales', 'hr']) {
                    await api('POST', '/capability', {
                        actor: 'user:root',
                        scope: `team:${t}`,
                        relation: 'lead',
                        cap_mask: 0x0030  // READ + WRITE
                    });
                    known.capabilities.push({ scope: `team:${t}`, relation: 'lead', cap_mask: 0x0030 });

                    await api('POST', '/capability', {
                        actor: 'user:root',
                        scope: `team:${t}`,
                        relation: 'member',
                        cap_mask: 0x0010  // READ only
                    });
                    known.capabilities.push({ scope: `team:${t}`, relation: 'member', cap_mask: 0x0010 });
                    await sleep(100);
                }

                // Assign leads
                const leads = [
                    { seeker: 'user:alice', scope: 'team:engineering' },
                    { seeker: 'user:bob', scope: 'team:sales' },
                    { seeker: 'user:charlie', scope: 'team:hr' }
                ];
                for (const l of leads) {
                    await api('POST', '/grant', { actor: 'user:root', seeker: l.seeker, relation: 'lead', scope: l.scope });
                    known.grants.push({ ...l, relation: 'lead' });
                    await sleep(100);
                }

                // Alice (eng lead) adds members
                for (const u of ['dave', 'eve']) {
                    await api('POST', '/grant', {
                        actor: 'user:alice',
                        seeker: `user:${u}`,
                        relation: 'member',
                        scope: 'team:engineering'
                    });
                    known.grants.push({ seeker: `user:${u}`, relation: 'member', scope: 'team:engineering' });
                    await sleep(100);
                }

            } else if (name === 'saas') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'admin' });
                known.entities.push({ id: 'user:admin', type: 'user' });

                // Create tenants
                for (const t of ['acme-corp', 'globex']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(100);
                }

                // Create users
                for (const u of ['alice', 'bob']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(100);
                }

                // Create resources
                for (const r of ['project-alpha', 'project-beta']) {
                    const res = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'resource', id: r });
                    if (res.ok) known.entities.push({ id: `resource:${r}`, type: 'resource' });

                    await api('POST', '/capability', {
                        actor: 'user:admin',
                        scope: `resource:${r}`,
                        relation: 'editor',
                        cap_mask: 0x0030
                    });
                    known.capabilities.push({ scope: `resource:${r}`, relation: 'editor', cap_mask: 0x0030 });

                    await api('POST', '/capability', {
                        actor: 'user:admin',
                        scope: `resource:${r}`,
                        relation: 'viewer',
                        cap_mask: 0x0010
                    });
                    known.capabilities.push({ scope: `resource:${r}`, relation: 'viewer', cap_mask: 0x0010 });
                    await sleep(100);
                }

                // Grants
                await api('POST', '/grant', { actor: 'user:admin', seeker: 'user:alice', relation: 'editor', scope: 'resource:project-alpha' });
                known.grants.push({ seeker: 'user:alice', relation: 'editor', scope: 'resource:project-alpha' });

                await api('POST', '/grant', { actor: 'user:admin', seeker: 'user:bob', relation: 'viewer', scope: 'resource:project-beta' });
                known.grants.push({ seeker: 'user:bob', relation: 'viewer', scope: 'resource:project-beta' });
            }

            log(`--- Template "${name}" complete ---`, 'info');
            renderAll();
            checkConnection();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================================================
        // UI
        // ============================================================================

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${name}')"]`).classList.add('active');
        }

        function updateCapValue() {
            let cap = 0;
            document.querySelectorAll('.cap-bit:checked').forEach(cb => {
                cap |= parseInt(cb.value);
            });
            document.getElementById('cap-value').textContent = '0x' + cap.toString(16).padStart(4, '0');
            document.getElementById('cap-decimal').textContent = cap;
        }

        function renderAll() {
            renderEntities();
            renderGrants();
            renderCapabilities();
        }

        function renderEntities() {
            const list = document.getElementById('entity-list');
            if (known.entities.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ“‹</div><p>No entities yet</p></div>';
                return;
            }
            list.innerHTML = known.entities.map(e => `
                <div class="list-item">
                    <span class="chip ${e.type}"><span class="type">${e.type}:</span>${e.id.split(':')[1]}</span>
                </div>
            `).join('');
        }

        function renderGrants() {
            const list = document.getElementById('grant-list');
            if (known.grants.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ”—</div><p>No grants yet</p></div>';
                return;
            }
            list.innerHTML = known.grants.map(g => {
                const seekerType = g.seeker.split(':')[0];
                const scopeType = g.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${g.seeker.split(':')[1]}</span>
                        <span class="arrow">â†’</span>
                        <span class="relation-badge">${g.relation}</span>
                        <span class="arrow">â†’</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${g.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderCapabilities() {
            const list = document.getElementById('cap-list');
            if (known.capabilities.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">âš¡</div><p>No capabilities yet</p></div>';
                return;
            }
            list.innerHTML = known.capabilities.map(c => {
                const scopeType = c.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${c.scope.split(':')[1]}</span>
                        <span class="relation-badge">${c.relation}</span>
                        <span class="cap-badge">0x${c.cap_mask.toString(16).padStart(4, '0')}</span>
                    </div>
                `;
            }).join('');
        }

        // Init
        document.querySelectorAll('.cap-bit').forEach(cb => {
            cb.addEventListener('change', updateCapValue);
        });

        // Auto-connect on load
        checkConnection();
    </script>
</body>
</html>
