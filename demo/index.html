<!DOCTYPE html>
<html><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Capbit</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--b:#0f172a;--c:#1e293b;--i:#334155;--t:#f1f5f9;--m:#94a3b8;--p:#6366f1;--g:#22c55e;--r:#ef4444}
body{font-family:system-ui;background:var(--b);color:var(--t)}
.w{max-width:500px;margin:0 auto;padding:1rem}
nav{background:var(--c);padding:.5rem .75rem;display:flex;gap:.5rem;flex-wrap:wrap;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--i)}
nav a{color:var(--m);text-decoration:none;font-size:.7rem;padding:.3rem .5rem;border-radius:4px;white-space:nowrap}
nav a:hover{background:var(--i);color:var(--t)}
h1{text-align:center;margin:1rem 0;font-size:1.5rem}h1 span{color:var(--p)}
.k{background:var(--c);border-radius:10px;margin-bottom:.75rem;overflow:hidden}
.t{font-size:.75rem;color:var(--m);padding:.75rem 1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none}
.t:hover{background:var(--i)}
.t::after{content:'â–¼';font-size:.6rem;transition:transform .2s}
.k.closed .t::after{transform:rotate(-90deg)}
.k.closed .bd{display:none}
.bd{padding:0 1rem 1rem}
.r{display:flex;gap:.5rem;margin-bottom:.5rem}
.c{flex:1;display:flex;flex-direction:column;gap:.2rem}
label{font-size:.75rem;color:var(--m)}
input,select{background:var(--i);border:1px solid #475569;border-radius:5px;padding:.4rem;color:var(--t);font-size:.85rem;width:100%}
input:focus,select:focus{outline:none;border-color:var(--p)}
button{background:var(--p);color:#fff;border:none;border-radius:5px;padding:.5rem;font-size:.85rem;cursor:pointer;width:100%;margin-top:.5rem}
button:hover{opacity:.9}.d{background:var(--r)}.sec{background:var(--i)}
.s{display:flex;align-items:center;gap:.5rem;font-size:.8rem}
.dot{width:8px;height:8px;border-radius:50%;background:var(--r)}.dot.ok{background:var(--g)}
.res{margin-top:.5rem;padding:.5rem;border-radius:5px;font-size:.8rem}
.res.ok{background:rgba(34,197,94,.15);border:1px solid var(--g)}
.res.er{background:rgba(239,68,68,.15);border:1px solid var(--r)}
.it{background:var(--i);border-radius:5px;padding:.4rem;margin-top:.3rem;font-size:.75rem;display:flex;justify-content:space-between}
.log{background:var(--b);border-radius:5px;padding:.5rem;max-height:120px;overflow-y:auto;font-size:.7rem;font-family:monospace}
.le{padding:.15rem 0;border-bottom:1px solid #334155}
.caps{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.25rem}.caps label{display:flex;align-items:center;gap:.2rem;font-size:.7rem;background:var(--i);padding:.25rem .5rem;border-radius:4px;cursor:pointer}
.caps input{width:auto}
.em{font-size:1rem;margin-right:.5rem}
</style>
</head><body>
<nav>
<a href="#entities">ğŸ‘¤ Users</a>
<a href="#grant">ğŸ”‘ Grant</a>
<a href="#check">âœ… Check</a>
<a href="#view">ğŸ“‹ View</a>
<a href="#roles">ğŸ­ Roles</a>
<a href="#inherit">ğŸ‘¥ Inherit</a>
</nav>
<div class="w">
<h1>Cap<span>bit</span></h1>

<div class="k" id="status"><div class="t"><span><span class="em">ğŸ“¡</span>Status</span></div>
<div class="bd"><div class="s"><div class="dot" id="dot"></div><span id="st">Connecting...</span></div></div></div>

<div class="k closed" id="setup"><div class="t" onclick="tog(this)"><span><span class="em">âš™ï¸</span>Setup</span></div>
<div class="bd">
<div class="c"><label>Admin User ID</label><input type="number" id="ri" value="1"></div>
<button onclick="boot()">Initialize System</button><div id="br"></div>
</div></div>

<div class="k" id="entities"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ‘¤</span>Users & Resources</span></div>
<div class="bd">
<div class="r"><div class="c"><label>Name</label><input id="enm" placeholder="alice, bob, report.pdf..."></div><button onclick="ent()" style="width:auto;padding:.4rem .8rem;margin:0;align-self:flex-end">+ Add</button></div>
<div id="eres"></div>
<div class="r" style="margin-top:.5rem"><div class="c"><label>Edit</label><select id="esel" class="sel"></select></div><div class="c"><label>Rename to</label><input id="ernm"></div></div>
<div class="r"><button onclick="ren()" class="sec" style="flex:1">Rename</button><button onclick="del()" class="d" style="flex:1">Delete</button></div>
</div></div>

<div class="k" id="grant"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ”‘</span>Grant Access</span></div>
<div class="bd">
<div class="r"><div class="c"><label>As (admin)</label><select id="ga" class="sel"></select></div><div class="c"><label>Grant to</label><select id="gs" class="sel"></select></div></div>
<div class="c"><label>On resource</label><select id="go" class="sel"></select></div>
<label style="margin-top:.5rem">Permissions</label><div class="caps" id="gcaps"></div>
<button onclick="grt()">ğŸ”‘ Grant Access</button><div id="gr"></div>
</div></div>

<div class="k" id="check"><div class="t" onclick="tog(this)"><span><span class="em">âœ…</span>Check Access</span></div>
<div class="bd">
<div class="r"><div class="c"><label>User</label><select id="cs" class="sel"></select></div><div class="c"><label>Resource</label><select id="co" class="sel"></select></div></div>
<label>Required permissions (optional)</label><div class="caps" id="ccaps"></div>
<button onclick="chk()">âœ… Check Access</button><div id="ck"></div>
</div></div>

<div class="k closed" id="view"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ“‹</span>View Permissions</span></div>
<div class="bd">
<div class="r"><div class="c"><label>By user</label><select id="ls" class="sel"></select></div><div class="c"><label>By resource</label><select id="lo" class="sel"></select></div></div>
<button class="sec" onclick="lst()">ğŸ“‹ Show Permissions</button><div id="lr"></div>
</div></div>

<div class="k closed" id="roles"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ­</span>Define Roles</span></div>
<div class="bd">
<p style="font-size:.7rem;color:var(--m);margin-bottom:.5rem">Create reusable permission templates</p>
<div class="r"><div class="c"><label>As (admin)</label><select id="ra" class="sel"></select></div><div class="c"><label>On resource</label><select id="ro" class="sel"></select></div></div>
<div class="c"><label>Role ID</label><input type="number" id="rr" value="1" style="width:80px"></div>
<label style="margin-top:.5rem">Role permissions</label><div class="caps" id="rcaps"></div>
<button class="sec" onclick="rol()">ğŸ’¾ Save Role</button><div id="rres"></div>
</div></div>

<div class="k closed" id="inherit"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ‘¥</span>Inheritance</span></div>
<div class="bd">
<p style="font-size:.7rem;color:var(--m);margin-bottom:.5rem">User inherits permissions from another user/group</p>
<div class="r"><div class="c"><label>As (admin)</label><select id="ia" class="sel"></select></div><div class="c"><label>On resource</label><select id="io" class="sel"></select></div></div>
<div class="r"><div class="c"><label>User</label><select id="ic" class="sel" onchange="exclude('ip',this.value)"></select></div><div class="c"><label>Inherits from</label><select id="ip" class="sel" onchange="exclude('ic',this.value)"></select></div></div>
<button class="sec" onclick="inh()">ğŸ”— Set Inheritance</button><div id="ir"></div>
</div></div>

<div class="k closed" id="log"><div class="t" onclick="tog(this)"><span><span class="em">ğŸ“œ</span>Activity Log</span></div>
<div class="bd"><div class="log" id="logc"></div></div></div>

<button class="d" onclick="rst()">ğŸ—‘ï¸ Reset Everything</button>
</div>

<script>
const $=id=>document.getElementById(id)
const CAPS=[['read',1],['write',2],['delete',4],['create',8],['grant',16],['exec',32]]
const tog=el=>el.parentElement.classList.toggle('closed')
const log=(m,ok=1)=>{const e=document.createElement('div');e.className='le';e.style.color=ok?'var(--g)':'var(--r)';e.textContent=new Date().toLocaleTimeString()+' '+(ok?'âœ“':'âœ—')+' '+m;$('logc').prepend(e)}
const api=async(m,u,b)=>{try{const o={method:m,headers:{'Content-Type':'application/json'}};if(b)o.body=JSON.stringify(b);const r=await(await fetch(u,o)).json();log(u.split('/').pop()+': '+(r.ok?'OK':r.error),r.ok);return r}catch(e){log(e,0);return{ok:0,error:e+''}}}
const res=(id,ok,m)=>$(id).innerHTML='<div class="res '+(ok?'ok':'er')+'">'+m+'</div>'
const getCaps=id=>CAPS.reduce((a,[n,v])=>a|($(id+'-'+n)?.checked?v:0),0)
const capsNames=m=>CAPS.filter(([,v])=>m&v).map(([n])=>n).join(', ')||'none'
const exclude=(id,v)=>[...$( id).options].forEach(o=>o.disabled=o.value&&o.value===v)

function initCaps(id){$(id).innerHTML=CAPS.map(([n])=>'<label><input type="checkbox" id="'+id+'-'+n+'">'+n+'</label>').join('')}
async function loadLabels(){
  const r=await api('GET','/labels');if(!r.ok)return
  const opts='<option value="">â€” select â€”</option>'+r.data.map(e=>'<option value="'+e.id+'">'+(e.label||'#'+e.id)+'</option>').join('')
  document.querySelectorAll('.sel').forEach(s=>{const v=s.value;s.innerHTML=opts;s.value=v})
  $('eres').innerHTML=r.data.length?r.data.map(e=>'<div class="it"><span>#'+e.id+'</span><span>'+(e.label||'â€”')+'</span></div>').join(''):'<div class="it" style="color:var(--m)">No entities yet. Add users and resources above.</div>'
}
async function ent(){const n=$('enm').value.trim();if(!n){res('eres',0,'Enter a name');return}const r=await api('POST','/entity',{name:n});res('eres',r.ok,r.ok?'âœ“ Created: '+n+' (#'+r.data+')':r.error);if(r.ok){$('enm').value='';loadLabels()}}
async function ren(){const id=$('esel').value,n=$('ernm').value.trim();if(!id){res('eres',0,'Select an entity');return}if(!n){res('eres',0,'Enter new name');return}const r=await api('POST','/entity/rename',{id:+id,name:n});res('eres',r.ok,r.ok?'âœ“ Renamed to: '+n:r.error);if(r.ok){$('ernm').value='';loadLabels()}}
async function del(){const id=$('esel').value;if(!id){res('eres',0,'Select an entity');return}if(!confirm('Delete this entity?'))return;const r=await api('POST','/entity/delete',{id:+id});res('eres',r.ok,r.ok?'âœ“ Deleted':r.error);if(r.ok)loadLabels()}

async function status(){const r=await api('GET','/status');if(r.ok){$('dot').classList.add('ok');$('st').textContent=r.data.bootstrapped?'âœ“ Ready (admin: #'+r.data.root+')':'âš ï¸ Not initialized';if(r.data.bootstrapped){$('setup').classList.add('closed');$('status').classList.add('closed')}else{$('setup').classList.remove('closed')}}}
async function boot(){const r=await api('POST','/bootstrap',{root_id:+$('ri').value||1});res('br',r.ok,r.ok?'âœ“ Initialized! Admin is #'+r.data:r.error);if(r.ok){status();loadLabels()}}
async function grt(){const a=$('ga').value,s=$('gs').value,o=$('go').value,m=getCaps('gcaps');if(!a||!s||!o){res('gr',0,'Select all fields');return}if(!m){res('gr',0,'Select at least one permission');return}const r=await api('POST','/grant',{actor:+a,subject:+s,object:+o,mask:m});res('gr',r.ok,r.ok?'âœ“ Access granted!':r.error)}
async function chk(){const s=$('cs').value,o=$('co').value;if(!s||!o){res('ck',0,'Select user and resource');return}const q=getCaps('ccaps'),r=await api('GET','/check?subject='+s+'&object='+o+'&required='+q);r.ok?res('ck',r.data.allowed,(r.data.allowed?'âœ… ALLOWED':'âŒ DENIED')+' â€” has: '+capsNames(r.data.mask)):res('ck',0,r.error)}
async function lst(){const s=$('ls').value,o=$('lo').value;if(!s&&!o){res('lr',0,'Select user or resource');return}const r=await api('GET','/list?'+(s?'subject='+s:'object='+o));r.ok?$('lr').innerHTML=r.data.length?r.data.map(e=>'<div class="it"><span>'+(e.label||'#'+e.id)+'</span><span>'+capsNames(e.mask)+'</span></div>').join(''):'<div class="it" style="color:var(--m)">No permissions found</div>':res('lr',0,r.error)}
async function rol(){const a=$('ra').value,o=$('ro').value;if(!a||!o){res('rres',0,'Select admin and resource');return}const r=await api('POST','/role',{actor:+a,object:+o,role_id:+$('rr').value,mask:getCaps('rcaps')});res('rres',r.ok,r.ok?'âœ“ Role saved!':r.error)}
async function inh(){const a=$('ia').value,o=$('io').value,c=$('ic').value,p=$('ip').value;if(!a||!o||!c||!p){res('ir',0,'Fill all fields');return}const r=await api('POST','/inherit',{actor:+a,object:+o,child:+c,parent:+p});res('ir',r.ok,r.ok?'âœ“ Inheritance set!':r.error)}
async function rst(){if(!confirm('âš ï¸ This will delete ALL data. Continue?'))return;if((await api('POST','/reset')).ok)location.reload()}

['gcaps','ccaps','rcaps'].forEach(initCaps)
status();loadLabels()
</script>
</body></html>
