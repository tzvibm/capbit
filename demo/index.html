<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capbit Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 5rem;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }

        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
        }

        h1 { font-size: 1.5rem; font-weight: 700; }
        h1 span { color: var(--primary); }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected { background: var(--success); }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-row.stack { flex-direction: column; }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .input-group label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        select, input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.625rem;
            color: var(--text);
            font-size: 0.875rem;
            width: 100%;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover { background: var(--primary-dark); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.sm { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        .btn.danger { background: var(--danger); }
        .btn.success { background: var(--success); }
        .btn.warning { background: var(--warning); }
        .btn.outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn.full { width: 100%; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-group .btn { flex: 1; }

        /* Log */
        .log {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.7rem;
            background: var(--bg);
            border-radius: 8px;
            padding: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
            word-break: break-all;
        }

        .log-entry:last-child { border-bottom: none; }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.info { color: var(--primary); }
        .log-entry.request { color: var(--warning); }
        .log-entry .time { color: var(--text-muted); margin-right: 0.5rem; }
        .log-entry .method {
            background: var(--bg-input);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }

        /* Result box */
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .result.allowed { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); }
        .result.denied { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); }

        .result-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .result-text { font-weight: 600; font-size: 1rem; }
        .result-detail { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 0.625rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-input);
            border-radius: 6px;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .chip .type { color: var(--primary); font-weight: 600; }
        .chip.user .type { color: #22c55e; }
        .chip.team .type { color: #f59e0b; }
        .chip.app .type { color: #ec4899; }
        .chip.resource .type { color: #06b6d4; }

        /* Lists */
        .list { display: flex; flex-direction: column; gap: 0.5rem; }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8125rem;
            flex-wrap: wrap;
        }

        .list-item .arrow { color: var(--text-muted); }

        .relation-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .cap-badge {
            font-family: monospace;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Config panel */
        .config-panel {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-row input {
            flex: 1;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <h1>Cap<span>bit</span></h1>
        <div class="status-bar">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </header>

    <div class="container">
        <!-- Server Config -->
        <div class="card">
            <div class="card-title">Server Connection</div>
            <div class="config-row">
                <input type="text" id="api-url" value="http://localhost:3000" placeholder="API URL">
                <button class="btn sm" onclick="checkConnection()">Connect</button>
            </div>
        </div>

        <!-- Activity Log - Always visible -->
        <div class="card">
            <div class="card-title">
                Activity Log
                <div style="display: flex; gap: 0.25rem;">
                    <button class="btn sm outline" onclick="copyLogs()">Copy</button>
                    <button class="btn sm outline" onclick="clearLog()">Clear</button>
                </div>
            </div>
            <div class="log" id="log"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">Setup</button>
            <button class="tab" onclick="showTab('entities')">Entities</button>
            <button class="tab" onclick="showTab('grants')">Grants</button>
            <button class="tab" onclick="showTab('caps')">Caps</button>
            <button class="tab" onclick="showTab('test')">Test</button>
        </div>

        <!-- Setup Tab -->
        <div id="tab-setup" class="tab-content active">
            <div class="card">
                <div class="card-title">Bootstrap System</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Root User ID</label>
                        <input type="text" id="bootstrap-root" value="root" placeholder="e.g. root, admin">
                    </div>
                </div>
                <button class="btn full" onclick="doBootstrap()">Bootstrap</button>
            </div>

            <div class="card">
                <div class="card-title">Quick Setup Templates</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Run a template to populate the system. Watch the log to see each API call.
                </p>
                <div class="btn-group">
                    <button class="btn warning" onclick="runTemplate('startup')">Startup</button>
                    <button class="btn warning" onclick="runTemplate('saas')">SaaS</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Danger Zone</div>
                <button class="btn danger full" onclick="doReset()">Reset Database</button>
            </div>
        </div>

        <!-- Entities Tab -->
        <div id="tab-entities" class="tab-content">
            <div class="card">
                <div class="card-title">Create Entity</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Type</label>
                        <select id="entity-type">
                            <option value="user">user</option>
                            <option value="team">team</option>
                            <option value="app">app</option>
                            <option value="resource">resource</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ID</label>
                        <input type="text" id="entity-id" placeholder="e.g. alice, engineering">
                    </div>
                </div>
                <div class="input-group">
                    <label>Actor (who's creating)</label>
                    <input type="text" id="entity-actor" value="user:root" placeholder="e.g. user:root">
                </div>
                <button class="btn full" onclick="doCreateEntity()">Create Entity</button>
            </div>

            <div class="card">
                <div class="card-title">Known Entities</div>
                <div class="list" id="entity-list">
                    <div class="empty">
                        <div class="empty-icon">üìã</div>
                        <p>Entities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grants Tab -->
        <div id="tab-grants" class="tab-content">
            <div class="card">
                <div class="card-title">Create Grant (Direct)</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's granting - must have GRANT_WRITE)</label>
                        <input type="text" id="grant-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="input-group">
                        <label>Seeker (who receives the grant)</label>
                        <input type="text" id="grant-seeker" placeholder="e.g. user:alice">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="grant-relation" placeholder="e.g. lead, member, editor">
                        </div>
                        <div class="input-group">
                            <label>Scope (on what)</label>
                            <input type="text" id="grant-scope" placeholder="e.g. team:engineering">
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateGrant()">Create Grant</button>
            </div>

            <div class="card">
                <div class="card-title">Create Delegation (Inherited)</div>
                <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    Delegation lets someone inherit another's permissions. The delegatee can never have MORE than the delegator.
                </p>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's delegating - must have DELEGATE_WRITE)</label>
                        <input type="text" id="deleg-actor" value="user:root" placeholder="e.g. user:alice">
                    </div>
                    <div class="input-group">
                        <label>Seeker (who inherits)</label>
                        <input type="text" id="deleg-seeker" placeholder="e.g. user:bob">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Scope (on what)</label>
                            <input type="text" id="deleg-scope" placeholder="e.g. resource:hq-office">
                        </div>
                        <div class="input-group">
                            <label>Delegate (inherit from)</label>
                            <input type="text" id="deleg-source" placeholder="e.g. user:alice">
                        </div>
                    </div>
                </div>
                <button class="btn full" style="background: var(--warning);" onclick="doCreateDelegation()">Create Delegation</button>
            </div>

            <div class="card">
                <div class="card-title">
                    Direct Grants
                    <span style="font-size: 0.65rem; color: var(--text-muted);">seeker ‚Üí relation ‚Üí scope</span>
                </div>
                <div class="list" id="grant-list">
                    <div class="empty">
                        <div class="empty-icon">üîó</div>
                        <p>No direct grants yet</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    Inherited (Delegations)
                    <span style="font-size: 0.65rem; color: var(--warning);">seeker inherits from delegate on scope</span>
                </div>
                <div class="list" id="delegation-list">
                    <div class="empty">
                        <div class="empty-icon">‚ÜóÔ∏è</div>
                        <p>No delegations yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capabilities Tab -->
        <div id="tab-caps" class="tab-content">
            <div class="card">
                <div class="card-title">Define Capability</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Actor (who's defining - must have CAP_WRITE)</label>
                        <input type="text" id="cap-actor" value="user:root" placeholder="e.g. user:root">
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Scope (on what entity)</label>
                            <input type="text" id="cap-scope" placeholder="e.g. team:engineering">
                        </div>
                        <div class="input-group">
                            <label>Relation</label>
                            <input type="text" id="cap-relation" placeholder="e.g. lead, member">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Capability Bits (define your own meanings)</label>
                        <div id="bit-selector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; margin-top: 0.25rem;">
                            <!-- Bits 0-15 generated by JS -->
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                            <span style="font-family: monospace; font-size: 0.85rem;">
                                Value: <strong id="cap-value">0x0000</strong>
                            </span>
                            <input type="text" id="cap-mask-input" placeholder="or type hex"
                                   style="font-family: monospace; width: 80px; padding: 0.25rem;"
                                   onchange="parseAndSetBits(this.value)">
                        </div>
                    </div>
                </div>
                <button class="btn full" onclick="doCreateCapability()">Define Capability</button>
            </div>

            <div class="card">
                <div class="card-title">Known Capabilities</div>
                <div class="list" id="cap-list">
                    <div class="empty">
                        <div class="empty-icon">‚ö°</div>
                        <p>Capabilities tracked client-side</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="tab-test" class="tab-content">
            <div class="card">
                <div class="card-title">Check Permission</div>
                <div class="form-row stack">
                    <div class="input-group">
                        <label>Subject (who's asking)</label>
                        <select id="check-subject">
                            <option value="">-- Select entity --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Object (accessing what)</label>
                        <select id="check-object">
                            <option value="">-- Select entity --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Required Capability</label>
                        <select id="check-cap">
                            <option value="0">ANY (0x0000)</option>
                        </select>
                    </div>
                </div>
                <button class="btn success full" onclick="doCheckAccess()">Check Access</button>
                <div id="check-result"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================

        let apiUrl = 'http://localhost:3000';
        let connected = false;

        // Client-side tracking (mirrors what we've created via API)
        const known = {
            entities: [],
            grants: [],
            capabilities: [],
            delegations: []
        };

        // ============================================================================
        // Logging
        // ============================================================================

        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">${time}</span>${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Keep log size reasonable
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function logRequest(method, endpoint, body = null) {
            let msg = `<span class="method">${method}</span> ${endpoint}`;
            if (body) {
                msg += ` <span style="color: var(--text-muted)">${JSON.stringify(body)}</span>`;
            }
            log(msg, 'request');
        }

        function logResponse(success, data) {
            if (success) {
                log(`‚úì ${JSON.stringify(data)}`, 'success');
            } else {
                log(`‚úó ${data}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        function copyLogs() {
            const logDiv = document.getElementById('log');
            const entries = [...logDiv.querySelectorAll('.log-entry')].reverse();
            const text = entries.map(e => e.textContent).join('\n');

            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    log('Logs copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            log('Logs copied to clipboard!', 'success');
        }

        // ============================================================================
        // API Calls
        // ============================================================================

        async function api(method, endpoint, body = null) {
            logRequest(method, endpoint, body);

            try {
                const opts = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`${apiUrl}${endpoint}`, opts);
                const json = await res.json();

                if (json.success) {
                    logResponse(true, json.data);
                    return { ok: true, data: json.data };
                } else {
                    logResponse(false, json.error);
                    return { ok: false, error: json.error };
                }
            } catch (e) {
                logResponse(false, e.message);
                return { ok: false, error: e.message };
            }
        }

        // ============================================================================
        // Connection
        // ============================================================================

        async function checkConnection() {
            const inputUrl = document.getElementById('api-url').value.trim();
            apiUrl = inputUrl ? inputUrl.replace(/\/$/, '') : '';  // Empty = same origin
            log(`Connecting to ${apiUrl || window.location.origin}...`, 'info');

            const result = await api('GET', '/status');

            if (result.ok) {
                connected = true;
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('status-text').textContent =
                    result.data.bootstrapped
                        ? `Connected (root: ${result.data.root_entity})`
                        : 'Connected (not bootstrapped)';
                // Load existing data from server
                await loadData();
            } else {
                connected = false;
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('status-text').textContent = 'Connection failed';
            }
        }

        async function loadData() {
            // Load entities
            const entitiesResult = await api('GET', '/entities');
            if (entitiesResult.ok) {
                known.entities = entitiesResult.data.map(e => ({
                    id: e.id,
                    type: e.entity_type
                }));
            }

            // Load grants
            const grantsResult = await api('GET', '/grants');
            if (grantsResult.ok) {
                known.grants = grantsResult.data.map(g => ({
                    seeker: g.seeker,
                    relation: g.relation,
                    scope: g.scope
                }));
            }

            // Load capabilities
            const capsResult = await api('GET', '/capabilities');
            if (capsResult.ok) {
                known.capabilities = capsResult.data.map(c => ({
                    scope: c.scope,
                    relation: c.relation,
                    cap_mask: c.cap_mask
                }));
            }

            renderAll();
        }

        // ============================================================================
        // Actions
        // ============================================================================

        async function doBootstrap() {
            const rootId = document.getElementById('bootstrap-root').value.trim();
            if (!rootId) return alert('Enter a root ID');

            const result = await api('POST', '/bootstrap', { root_id: rootId });
            if (result.ok) {
                known.entities.push({ id: `user:${rootId}`, type: 'user' });
                renderEntities();
                renderTestSelects();
                checkConnection();
            }
        }

        async function doReset() {
            if (!confirm('Reset entire database? This cannot be undone.')) return;

            const result = await api('POST', '/reset');
            if (result.ok) {
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                known.delegations = [];
                renderAll();
                checkConnection();
            }
        }

        async function doCreateEntity() {
            const actor = document.getElementById('entity-actor').value.trim();
            const entityType = document.getElementById('entity-type').value;
            const id = document.getElementById('entity-id').value.trim();

            if (!actor || !id) return alert('Fill all fields');

            const result = await api('POST', '/entity', {
                actor,
                entity_type: entityType,
                id
            });

            if (result.ok) {
                known.entities.push({ id: `${entityType}:${id}`, type: entityType });
                document.getElementById('entity-id').value = '';
                renderEntities();
                renderTestSelects();
            }
        }

        async function doCreateGrant() {
            const actor = document.getElementById('grant-actor').value.trim();
            const seeker = document.getElementById('grant-seeker').value.trim();
            const relation = document.getElementById('grant-relation').value.trim();
            const scope = document.getElementById('grant-scope').value.trim();

            if (!actor || !seeker || !relation || !scope) return alert('Fill all fields');

            const result = await api('POST', '/grant', { actor, seeker, relation, scope });

            if (result.ok) {
                known.grants.push({ seeker, relation, scope });
                document.getElementById('grant-seeker').value = '';
                document.getElementById('grant-relation').value = '';
                document.getElementById('grant-scope').value = '';
                renderGrants();
            }
        }

        async function doCreateDelegation() {
            const actor = document.getElementById('deleg-actor').value.trim();
            const seeker = document.getElementById('deleg-seeker').value.trim();
            const scope = document.getElementById('deleg-scope').value.trim();
            const delegate = document.getElementById('deleg-source').value.trim();

            if (!actor || !seeker || !scope || !delegate) return alert('Fill all fields');

            // Delegation uses the inheritance API
            const result = await api('POST', '/delegation', { actor, seeker, scope, delegate });

            if (result.ok) {
                known.delegations.push({ seeker, scope, delegate });
                document.getElementById('deleg-seeker').value = '';
                document.getElementById('deleg-scope').value = '';
                document.getElementById('deleg-source').value = '';
                renderDelegations();
            }
        }

        // Bit selector state
        let selectedBits = 0;

        function initBitSelector() {
            const container = document.getElementById('bit-selector');
            container.innerHTML = '';
            // Show first 16 bits (expandable)
            for (let i = 0; i < 16; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'bit-btn';
                btn.dataset.bit = i;
                btn.textContent = i;
                btn.style.cssText = 'padding: 0.25rem; font-size: 0.65rem; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-muted); border-radius: 4px; cursor: pointer;';
                btn.onclick = () => toggleBit(i);
                container.appendChild(btn);
            }
            updateBitDisplay();
        }

        function toggleBit(bit) {
            selectedBits ^= (1 << bit);
            updateBitDisplay();
        }

        function updateBitDisplay() {
            document.querySelectorAll('.bit-btn').forEach(btn => {
                const bit = parseInt(btn.dataset.bit);
                const isSet = (selectedBits & (1 << bit)) !== 0;
                btn.style.background = isSet ? 'var(--primary)' : 'var(--bg-input)';
                btn.style.color = isSet ? 'white' : 'var(--text-muted)';
            });
            document.getElementById('cap-value').textContent = '0x' + selectedBits.toString(16).padStart(4, '0');
            document.getElementById('cap-mask-input').value = '0x' + selectedBits.toString(16).padStart(4, '0');
        }

        function parseAndSetBits(str) {
            str = str.trim().toLowerCase();
            let val = str.startsWith('0x') ? parseInt(str, 16) : parseInt(str, 10);
            if (!isNaN(val) && val >= 0) {
                selectedBits = val;
                updateBitDisplay();
            }
        }

        async function doCreateCapability() {
            const actor = document.getElementById('cap-actor').value.trim();
            const scope = document.getElementById('cap-scope').value.trim();
            const relation = document.getElementById('cap-relation').value.trim();
            const capMask = selectedBits;

            if (!actor || !scope || !relation) return alert('Fill all fields');
            if (capMask === 0) return alert('Select at least one capability bit');

            const result = await api('POST', '/capability', {
                actor,
                scope,
                relation,
                cap_mask: capMask
            });

            if (result.ok) {
                known.capabilities.push({ scope, relation, cap_mask: capMask });
                document.getElementById('cap-scope').value = '';
                document.getElementById('cap-relation').value = '';
                selectedBits = 0;
                updateBitDisplay();
                renderCapabilities();
                renderTestSelects();
            }
        }

        async function doCheckAccess() {
            const subject = document.getElementById('check-subject').value.trim();
            const object = document.getElementById('check-object').value.trim();
            const required = parseInt(document.getElementById('check-cap').value);

            if (!subject || !object) return alert('Fill subject and object');

            const result = await api('POST', '/check', { subject, object, required });

            const resultDiv = document.getElementById('check-result');
            if (result.ok) {
                const { allowed, effective, effective_string, required_string } = result.data;
                resultDiv.className = `result ${allowed ? 'allowed' : 'denied'}`;
                resultDiv.innerHTML = `
                    <div class="result-icon">${allowed ? '‚úì' : '‚úó'}</div>
                    <div class="result-text">${allowed ? 'ACCESS ALLOWED' : 'ACCESS DENIED'}</div>
                    <div class="result-detail">
                        Required: 0x${required.toString(16).padStart(4, '0')} (${required_string})<br>
                        Effective: 0x${effective.toString(16).padStart(4, '0')} (${effective_string})
                    </div>
                `;
            } else {
                resultDiv.className = 'result denied';
                resultDiv.innerHTML = `
                    <div class="result-icon">‚ö†</div>
                    <div class="result-text">ERROR</div>
                    <div class="result-detail">${result.error}</div>
                `;
            }
        }

        // ============================================================================
        // Templates
        // ============================================================================

        async function runTemplate(name) {
            // Check if already bootstrapped
            const status = await api('GET', '/status');
            if (status.ok && status.data.bootstrapped) {
                if (!confirm(`System is already bootstrapped (root: ${status.data.root_entity}).\n\nReset database and run "${name}" template?`)) {
                    return;
                }
                // Reset first
                log('Resetting database...', 'info');
                await api('POST', '/reset');
                known.entities = [];
                known.grants = [];
                known.capabilities = [];
                known.delegations = [];
            } else {
                if (!confirm(`Run "${name}" template? This will create entities, grants, and capabilities.`)) return;
            }

            log(`--- Running template: ${name} ---`, 'info');

            if (name === 'startup') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'root' });
                known.entities.push({ id: 'user:root', type: 'user' });

                // Create users
                for (const u of ['alice', 'bob', 'charlie']) {
                    const r = await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create an office with equipment
                await api('POST', '/entity', { actor: 'user:root', entity_type: 'resource', id: 'hq-office' });
                known.entities.push({ id: 'resource:hq-office', type: 'resource' });
                await sleep(50);

                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 1: Define CAPABILITIES on resource:hq-office', 'info');
                log('        (what each relation NAME means in terms of bits)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CAPABILITIES define what relation names MEAN on this entity
                // The BITS are the primitives: bit0=enter, bit1=print, etc.
                // The RELATION NAME maps to a bitmask combination
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                //
                // Primitives (what each bit means on this entity):
                //   bit0 = enter building
                //   bit1 = use printer
                //   bit2 = use fax machine
                //   bit3 = open safe
                //   bit4 = access server room
                //   bit5 = can grant access to others
                //
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                const capabilities = [
                    { relation: 'visitor',    cap: 0x01, desc: 'bit0 only (enter)' },
                    { relation: 'intern',     cap: 0x03, desc: 'bits 0-1 (enter + print)' },
                    { relation: 'employee',   cap: 0x07, desc: 'bits 0-2 (enter + print + fax)' },
                    { relation: 'manager',    cap: 0x0F, desc: 'bits 0-3 (+ safe)' },
                    { relation: 'sysadmin',   cap: 0x17, desc: 'bits 0-2,4 (+ server room)' },
                    { relation: 'full-access',cap: 0x3F, desc: 'all bits (everything + can grant)' },
                ];

                for (const c of capabilities) {
                    log(`  Capability: "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', {
                        actor: 'user:root',
                        scope: 'resource:hq-office',
                        relation: c.relation,
                        cap_mask: c.cap
                    });
                    known.capabilities.push({ scope: 'resource:hq-office', relation: c.relation, cap_mask: c.cap });
                    await sleep(50);
                }

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 2: Create GRANTS (business rules - who has what)', 'info');
                log('        Grants ARE the role assignments!', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // GRANTS are the business rules - they assign relations to seekers
                // The GRANT is the "role" - it's the assignment that says
                // "this person has this relation on this entity"
                const grants = [
                    // Alice gets full-access grant on the office
                    { actor: 'user:root', seeker: 'user:alice', relation: 'full-access', scope: 'resource:hq-office' },
                    // Bob gets employee grant - can enter, print, fax
                    { actor: 'user:root', seeker: 'user:bob', relation: 'employee', scope: 'resource:hq-office' },
                    // Charlie gets visitor grant - can only enter
                    { actor: 'user:alice', seeker: 'user:charlie', relation: 'visitor', scope: 'resource:hq-office' },
                ];

                for (const g of grants) {
                    log(`  Grant: ${g.seeker} -> "${g.relation}" on ${g.scope}`, 'info');
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                    await sleep(50);
                }

                // Create a new user for delegation demo
                await api('POST', '/entity', { actor: 'user:root', entity_type: 'user', id: 'dana' });
                known.entities.push({ id: 'user:dana', type: 'user' });
                await sleep(50);

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 3: Create DELEGATION (inherited grant)', 'info');
                log('        Dana inherits Alice\'s grants on hq-office', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // First, give alice the ability to delegate (via DELEGATE_WRITE)
                await api('POST', '/capability', {
                    actor: 'user:root',
                    scope: 'resource:hq-office',
                    relation: 'can-delegate',
                    cap_mask: 0x0800  // DELEGATE_WRITE
                });
                known.capabilities.push({ scope: 'resource:hq-office', relation: 'can-delegate', cap_mask: 0x0800 });

                await api('POST', '/grant', {
                    actor: 'user:root',
                    seeker: 'user:alice',
                    relation: 'can-delegate',
                    scope: 'resource:hq-office'
                });
                known.grants.push({ seeker: 'user:alice', relation: 'can-delegate', scope: 'resource:hq-office' });
                await sleep(50);

                // Now alice delegates her office access to dana
                // Dana will INHERIT alice's grants (but never MORE than alice has)
                log('  Delegation: dana inherits from alice on hq-office', 'info');
                await api('POST', '/delegation', {
                    actor: 'user:alice',
                    seeker: 'user:dana',
                    scope: 'resource:hq-office',
                    delegate: 'user:alice'
                });
                known.delegations.push({ seeker: 'user:dana', scope: 'resource:hq-office', delegate: 'user:alice' });
                await sleep(50);

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('SUMMARY:', 'info');
                log('  Entities: things (users, office)', 'info');
                log('  Capabilities: what relation names mean (visitor=0x01, employee=0x07)', 'info');
                log('  Grants: business rules assigning relations to seekers', 'info');
                log('  Delegations: inherited grants (dana inherits from alice)', 'info');
                log('', 'info');
                log('TEST SUGGESTIONS:', 'info');
                log('  - bob on hq-office with 0x04 (bit2=fax) -> ALLOWED (employee=0x07)', 'info');
                log('  - charlie on hq-office with 0x04 -> DENIED (visitor=0x01)', 'info');
                log('  - dana on hq-office with 0x0F -> ALLOWED (inherited from alice)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            } else if (name === 'saas') {
                // Bootstrap
                await api('POST', '/bootstrap', { root_id: 'admin' });
                known.entities.push({ id: 'user:admin', type: 'user' });

                // Create tenant orgs
                for (const t of ['acme', 'globex']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'team', id: t });
                    if (r.ok) known.entities.push({ id: `team:${t}`, type: 'team' });
                    await sleep(50);
                }

                // Create users
                for (const u of ['alice', 'bob', 'charlie', 'dana']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: u });
                    if (r.ok) known.entities.push({ id: `user:${u}`, type: 'user' });
                    await sleep(50);
                }

                // Create apps/services
                for (const a of ['api-gateway', 'dashboard', 'analytics']) {
                    const r = await api('POST', '/entity', { actor: 'user:admin', entity_type: 'app', id: a });
                    if (r.ok) known.entities.push({ id: `app:${a}`, type: 'app' });
                    await sleep(50);
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 1: Define CAPABILITIES on each entity
                // Capabilities map relation names to bitmasks (primitives)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 1: Define CAPABILITIES on app:api-gateway', 'info');
                log('        Primitives: bit0=read, bit1=write, bit2=delete, etc.', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                const apiCaps = [
                    { relation: 'free',       cap: 0x01,  desc: 'bit0 only (read)' },
                    { relation: 'basic',      cap: 0x03,  desc: 'bits 0-1 (read + write)' },
                    { relation: 'pro',        cap: 0x1F,  desc: 'bits 0-4 (CRUD + bulk + webhooks)' },
                    { relation: 'enterprise', cap: 0xFF,  desc: 'all bits (unlimited)' }
                ];
                for (const c of apiCaps) {
                    log(`  Capability: "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', { actor: 'user:admin', scope: 'app:api-gateway', relation: c.relation, cap_mask: c.cap });
                    known.capabilities.push({ scope: 'app:api-gateway', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                log('', 'info');
                log('Define CAPABILITIES on app:dashboard', 'info');
                log('        Primitives: bit0=view, bit1=create, bit2=share, bit3=schedule', 'info');
                const dashCaps = [
                    { relation: 'viewer',     cap: 0x01, desc: 'bit0 only (view)' },
                    { relation: 'analyst',    cap: 0x07, desc: 'bits 0-2 (view + create + share)' },
                    { relation: 'power-user', cap: 0x0F, desc: 'all bits' }
                ];
                for (const c of dashCaps) {
                    log(`  Capability: "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', { actor: 'user:admin', scope: 'app:dashboard', relation: c.relation, cap_mask: c.cap });
                    known.capabilities.push({ scope: 'app:dashboard', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                log('', 'info');
                log('Define CAPABILITIES on app:analytics', 'info');
                log('        Primitives: bit0=basic, bit1=advanced, bit2=raw, bit3=ML', 'info');
                const analyticsCaps = [
                    { relation: 'basic-user', cap: 0x01, desc: 'bit0 only' },
                    { relation: 'analyst',    cap: 0x03, desc: 'bits 0-1' },
                    { relation: 'data-eng',   cap: 0x07, desc: 'bits 0-2' },
                    { relation: 'ml-admin',   cap: 0x0F, desc: 'all bits' }
                ];
                for (const c of analyticsCaps) {
                    log(`  Capability: "${c.relation}" = 0x${c.cap.toString(16).padStart(2, '0')} (${c.desc})`, 'info');
                    await api('POST', '/capability', { actor: 'user:admin', scope: 'app:analytics', relation: c.relation, cap_mask: c.cap });
                    known.capabilities.push({ scope: 'app:analytics', relation: c.relation, cap_mask: c.cap });
                }
                await sleep(50);

                log('', 'info');
                log('Define CAPABILITIES on team:acme and team:globex', 'info');
                log('        Primitives: bit8=view, bit9=invite, bit10=billing, bit11=settings', 'info');
                const tenantCaps = [
                    { relation: 'member',  cap: 0x100,  desc: 'bit8 only (view)' },
                    { relation: 'manager', cap: 0x300,  desc: 'bits 8-9 (view + invite)' },
                    { relation: 'billing', cap: 0x500,  desc: 'bits 8,10 (view + billing)' },
                    { relation: 'owner',   cap: 0xF00,  desc: 'bits 8-11 (all org)' }
                ];
                for (const tenant of ['acme', 'globex']) {
                    for (const c of tenantCaps) {
                        await api('POST', '/capability', { actor: 'user:admin', scope: `team:${tenant}`, relation: c.relation, cap_mask: c.cap });
                        known.capabilities.push({ scope: `team:${tenant}`, relation: c.relation, cap_mask: c.cap });
                    }
                }
                await sleep(50);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 2: Create GRANTS (business rules - who has what)
                // Grants ARE the role assignments!
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 2: Create GRANTS (business rules - who has what)', 'info');
                log('        Grants ARE the role assignments!', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Grants assign relations to seekers - these ARE the role assignments
                const grants = [
                    // Alice: owner of Acme, enterprise API, power-user dashboard, ml-admin analytics
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'owner', scope: 'team:acme' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'enterprise', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'power-user', scope: 'app:dashboard' },
                    { actor: 'user:admin', seeker: 'user:alice', relation: 'ml-admin', scope: 'app:analytics' },
                    // Bob: member of Acme, pro API, analyst dashboard
                    { actor: 'user:alice', seeker: 'user:bob', relation: 'member', scope: 'team:acme' },
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'pro', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:bob', relation: 'analyst', scope: 'app:dashboard' },
                    // Charlie: owner of Globex, basic API, viewer dashboard
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'owner', scope: 'team:globex' },
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'basic', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:charlie', relation: 'viewer', scope: 'app:dashboard' },
                    // Dana: member of Globex, free API, basic analytics
                    { actor: 'user:charlie', seeker: 'user:dana', relation: 'member', scope: 'team:globex' },
                    { actor: 'user:admin', seeker: 'user:dana', relation: 'free', scope: 'app:api-gateway' },
                    { actor: 'user:admin', seeker: 'user:dana', relation: 'basic-user', scope: 'app:analytics' },
                ];

                for (const g of grants) {
                    log(`  Grant: ${g.seeker} -> "${g.relation}" on ${g.scope}`, 'info');
                    await api('POST', '/grant', g);
                    known.grants.push({ seeker: g.seeker, relation: g.relation, scope: g.scope });
                    await sleep(50);
                }

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STEP 3: Create DELEGATION (inherited grants)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('STEP 3: Create DELEGATION (inherited grants)', 'info');
                log('        Contractor inherits Alice\'s grants on api-gateway', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

                // Create a contractor user
                await api('POST', '/entity', { actor: 'user:admin', entity_type: 'user', id: 'contractor' });
                known.entities.push({ id: 'user:contractor', type: 'user' });
                await sleep(50);

                // Give alice ability to delegate on api-gateway
                await api('POST', '/capability', {
                    actor: 'user:admin',
                    scope: 'app:api-gateway',
                    relation: 'can-delegate',
                    cap_mask: 0x0800  // DELEGATE_WRITE
                });
                known.capabilities.push({ scope: 'app:api-gateway', relation: 'can-delegate', cap_mask: 0x0800 });
                await api('POST', '/grant', {
                    actor: 'user:admin',
                    seeker: 'user:alice',
                    relation: 'can-delegate',
                    scope: 'app:api-gateway'
                });
                known.grants.push({ seeker: 'user:alice', relation: 'can-delegate', scope: 'app:api-gateway' });
                await sleep(50);

                // Alice delegates her API access to contractor
                log('  Delegation: contractor inherits from alice on api-gateway', 'info');
                await api('POST', '/delegation', {
                    actor: 'user:alice',
                    seeker: 'user:contractor',
                    scope: 'app:api-gateway',
                    delegate: 'user:alice'
                });
                known.delegations.push({ seeker: 'user:contractor', scope: 'app:api-gateway', delegate: 'user:alice' });
                await sleep(50);

                log('', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                log('SUMMARY:', 'info');
                log('  Entities: things (users, apps, teams)', 'info');
                log('  Capabilities: what relation names mean (free=0x01, enterprise=0xFF)', 'info');
                log('  Grants: business rules assigning relations to seekers', 'info');
                log('  Delegations: inherited grants (contractor inherits from alice)', 'info');
                log('', 'info');
                log('TEST SUGGESTIONS:', 'info');
                log('  - alice on api-gateway with 0xFF -> ALLOWED (enterprise)', 'info');
                log('  - bob on api-gateway with 0x80 -> DENIED (pro=0x1F)', 'info');
                log('  - contractor on api-gateway with 0xFF -> ALLOWED (inherited!)', 'info');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            }

            log(`--- Template "${name}" complete ---`, 'info');
            renderAll();
            checkConnection();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================================================
        // UI
        // ============================================================================

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${name}')"]`).classList.add('active');
        }

        function renderAll() {
            renderEntities();
            renderGrants();
            renderDelegations();
            renderCapabilities();
            renderTestSelects();
        }

        function renderTestSelects() {
            const subjectSelect = document.getElementById('check-subject');
            const objectSelect = document.getElementById('check-object');
            const capSelect = document.getElementById('check-cap');

            // Filter out system _type: entities from dropdowns
            const orgEntities = known.entities.filter(e => !e.id.startsWith('_type:'));
            const entityOptions = orgEntities.map(e =>
                `<option value="${e.id}">${e.id}</option>`
            ).join('');

            const placeholder = '<option value="">-- Select entity --</option>';
            subjectSelect.innerHTML = placeholder + entityOptions;
            objectSelect.innerHTML = placeholder + entityOptions;

            // Build capability options from org-defined capabilities
            const orgCaps = known.capabilities.filter(c => !c.scope.startsWith('_type:'));

            // Get unique cap_mask values with their relation names
            const capMap = new Map();
            orgCaps.forEach(c => {
                const key = c.cap_mask;
                if (!capMap.has(key)) {
                    capMap.set(key, []);
                }
                capMap.get(key).push(c.relation);
            });

            // Sort by cap_mask value
            const sortedCaps = [...capMap.entries()].sort((a, b) => a[0] - b[0]);

            let capOptions = '<option value="0">ANY (0x0000)</option>';
            sortedCaps.forEach(([mask, relations]) => {
                const uniqueRelations = [...new Set(relations)].slice(0, 3).join(', ');
                capOptions += `<option value="${mask}">${uniqueRelations} (0x${mask.toString(16).padStart(4, '0')})</option>`;
            });

            capSelect.innerHTML = capOptions;
        }

        function renderEntities() {
            const list = document.getElementById('entity-list');
            // Filter out system _type: entities
            const orgEntities = known.entities.filter(e => !e.id.startsWith('_type:'));
            if (orgEntities.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No entities yet</p></div>';
                return;
            }
            list.innerHTML = orgEntities.map(e => `
                <div class="list-item">
                    <span class="chip ${e.type}"><span class="type">${e.type}:</span>${e.id.split(':')[1]}</span>
                </div>
            `).join('');
        }

        function renderGrants() {
            const list = document.getElementById('grant-list');
            // Filter out system _type: grants (root's admin on _type:*)
            const orgGrants = known.grants.filter(g => !g.scope.startsWith('_type:'));
            if (orgGrants.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">üîó</div><p>No direct grants yet</p></div>';
                return;
            }
            list.innerHTML = orgGrants.map(g => {
                const seekerType = g.seeker.split(':')[0];
                const scopeType = g.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${g.seeker.split(':')[1]}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="relation-badge">${g.relation}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${g.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderDelegations() {
            const list = document.getElementById('delegation-list');
            if (known.delegations.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">‚ÜóÔ∏è</div><p>No delegations yet</p></div>';
                return;
            }
            list.innerHTML = known.delegations.map(d => {
                const seekerType = d.seeker.split(':')[0];
                const delegateType = d.delegate.split(':')[0];
                const scopeType = d.scope.split(':')[0];
                return `
                    <div class="list-item" style="background: rgba(245, 158, 11, 0.1);">
                        <span class="chip ${seekerType}"><span class="type">${seekerType}:</span>${d.seeker.split(':')[1]}</span>
                        <span class="arrow" style="color: var(--warning);">inherits from</span>
                        <span class="chip ${delegateType}"><span class="type">${delegateType}:</span>${d.delegate.split(':')[1]}</span>
                        <span class="arrow">on</span>
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${d.scope.split(':')[1]}</span>
                    </div>
                `;
            }).join('');
        }

        function renderCapabilities() {
            const list = document.getElementById('cap-list');
            // Filter out system _type: capabilities (bootstrap admin caps)
            const orgCaps = known.capabilities.filter(c => !c.scope.startsWith('_type:'));
            if (orgCaps.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">‚ö°</div><p>No capabilities yet</p></div>';
                return;
            }
            list.innerHTML = orgCaps.map(c => {
                const scopeType = c.scope.split(':')[0];
                return `
                    <div class="list-item">
                        <span class="chip ${scopeType}"><span class="type">${scopeType}:</span>${c.scope.split(':')[1]}</span>
                        <span class="relation-badge">${c.relation}</span>
                        <span class="cap-badge">0x${c.cap_mask.toString(16).padStart(4, '0')}</span>
                    </div>
                `;
            }).join('');
        }

        // Init
        initBitSelector();

        // Auto-connect on load
        checkConnection();
    </script>
</body>
</html>
