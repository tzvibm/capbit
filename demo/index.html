<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capbit Demo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem;">
            <h1>Cap<span>bit</span></h1>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div class="status-dot" id="status-dot"></div>
                <span id="auth-status" style="font-size: 0.75rem; color: var(--text-muted);">Not logged in</span>
                <button id="logout-btn" class="btn sm outline" onclick="doLogout()" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('home')" id="tab-btn-home">Home</button>
            <button class="tab" onclick="showTab('query')">Query</button>
            <button class="tab" onclick="showTab('logs')">Logs</button>
            <button class="tab" onclick="showTab('setup')">Setup</button>
        </div>

        <!-- Setup Tab -->
        <div id="tab-setup" class="tab-content">
            <!-- Auth Card -->
            <div class="card" id="auth-card">
                <div class="card-title">Authentication</div>
                <div id="auth-logged-out">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        Not logged in. Bootstrap to create root user, or login with password/token.
                    </p>
                    <div class="form-row" style="margin-bottom: 0.75rem;">
                        <div class="input-group">
                            <label>Username</label>
                            <input type="text" id="login-entity" placeholder="e.g. root">
                        </div>
                        <div class="input-group">
                            <label>Password</label>
                            <input type="password" id="login-password" placeholder="Your password">
                        </div>
                    </div>
                    <button class="btn full" onclick="doPasswordLogin()" style="margin-bottom: 0.75rem;">Login with Password</button>
                    <p style="font-size: 0.7rem; color: var(--text-muted); text-align: center; margin-bottom: 0.5rem;">or</p>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label>Token</label>
                        <input type="text" id="login-token" placeholder="Paste your token here">
                    </div>
                    <button class="btn outline full" onclick="doLogin()">Login with Token</button>
                </div>
                <div id="auth-logged-in" style="display: none;">
                    <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                        Logged in as: <strong id="logged-in-entity"></strong>
                    </p>
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        Token: <code id="current-token" style="font-size: 0.65rem;"></code>
                    </p>
                    <button class="btn outline full" onclick="doCopyToken()">Copy Token</button>
                </div>
            </div>

            <div class="card" id="bootstrap-card">
                <div class="card-title">Bootstrap System</div>
                <p id="bootstrap-status" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;"></p>
                <div id="bootstrap-form">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Root User ID</label>
                            <input type="text" id="bootstrap-root" value="root" placeholder="e.g. root, admin">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Password (optional)</label>
                            <input type="password" id="bootstrap-password" placeholder="Set a password for login">
                        </div>
                    </div>
                    <button class="btn full" onclick="doBootstrap()">Bootstrap</button>
                </div>
            </div>

            <div class="card" id="set-password-card" style="display: none;">
                <div class="card-title">Set User Password</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Set password for yourself or another user (requires admin).
                </p>
                <div class="form-row">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" id="set-password-entity" placeholder="e.g. alice">
                    </div>
                    <div class="input-group">
                        <label>New Password</label>
                        <input type="password" id="set-password-value" placeholder="New password">
                    </div>
                </div>
                <button class="btn full" onclick="doSetPassword()" style="margin-top: 0.5rem;">Set Password</button>
            </div>

            <div class="card">
                <div class="card-title">Quick Setup Templates</div>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Run a template to populate the system. Watch the log to see each API call.
                </p>
                <div class="btn-group">
                    <button class="btn warning" onclick="runTemplate('startup')">Startup</button>
                    <button class="btn warning" onclick="runTemplate('saas')">SaaS</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Danger Zone</div>
                <button class="btn danger full" onclick="doReset()">Reset Database</button>
            </div>
        </div>

        <!-- Home Tab -->
        <div id="tab-home" class="tab-content active">
            <div class="home-list">
                <div class="home-card" onclick="toggleMini('types')">
                    <span class="hc-icon">üìÅ</span>
                    <span class="hc-name">Types</span>
                    <span class="hc-count" id="count-types">0</span>
                </div>
                <div class="expand-section hidden" id="section-types"><div id="type-list"></div></div>

                <div class="home-card" onclick="toggleMini('entities')">
                    <span class="hc-icon">üë§</span>
                    <span class="hc-name">Entities</span>
                    <span class="hc-count" id="count-entities">0</span>
                </div>
                <div class="expand-section hidden" id="section-entities"><div id="entity-list"></div></div>

                <div class="home-card" onclick="toggleMini('capbits')">
                    <span class="hc-icon">‚ö°</span>
                    <span class="hc-name">Actions</span>
                    <span class="hc-count" id="count-capbits">0</span>
                </div>
                <div class="expand-section hidden" id="section-capbits"><div id="primitive-cap-list"></div></div>

                <div class="home-card" onclick="toggleMini('relations')">
                    <span class="hc-icon">üë•</span>
                    <span class="hc-name">Groups</span>
                    <span class="hc-count" id="count-relations">0</span>
                </div>
                <div class="expand-section hidden" id="section-relations"><div id="cap-list"></div></div>

                <div class="home-card" onclick="toggleMini('grants')">
                    <span class="hc-icon">üîë</span>
                    <span class="hc-name">Members</span>
                    <span class="hc-count" id="count-grants">0</span>
                </div>
                <div class="expand-section hidden" id="section-grants"><div id="grant-list"></div></div>

                <div class="home-card" onclick="toggleMini('delegations')">
                    <span class="hc-icon">üîó</span>
                    <span class="hc-name">Sharing</span>
                    <span class="hc-count" id="count-delegations">0</span>
                </div>
                <div class="expand-section hidden" id="section-delegations"><div id="delegation-list"></div></div>
            </div>
        </div>

        <!-- Query Tab -->
        <div id="tab-query" class="tab-content">
            <div class="home-list">
                <div class="home-card" onclick="showQuery('check')">
                    <span class="hc-icon">üîê</span>
                    <span class="hc-name">Check Access</span>
                </div>
                <div class="expand-section hidden" id="qf-check">
                    <div class="form-row stack">
                        <div class="input-group">
                            <label>Who?</label>
                            <select id="check-subject"><option value="">-- Select --</option></select>
                        </div>
                        <div class="input-group">
                            <label>Accessing what?</label>
                            <select id="check-object"><option value="">-- Select --</option></select>
                        </div>
                        <div class="input-group">
                            <label>Required</label>
                            <select id="check-cap"><option value="0">Any (0x0000)</option></select>
                        </div>
                    </div>
                    <button class="btn success full mt-1" onclick="doCheckAccess()">Check</button>
                    <div id="check-result"></div>
                </div>

                <div class="home-card" onclick="showQuery('outbound')">
                    <span class="hc-icon">üì§</span>
                    <span class="hc-name">What Can They Access?</span>
                </div>
                <div class="expand-section hidden" id="qf-outbound">
                    <div class="input-group">
                        <label>Who?</label>
                        <select id="query-subject"><option value="">-- Select --</option></select>
                    </div>
                    <button class="btn success full mt-1" onclick="doQueryAccessible()">Show</button>
                    <div id="accessible-result"></div>
                </div>

                <div class="home-card" onclick="showQuery('inbound')">
                    <span class="hc-icon">üì•</span>
                    <span class="hc-name">Who Has Access?</span>
                </div>
                <div class="expand-section hidden" id="qf-inbound">
                    <div class="input-group">
                        <label>To what?</label>
                        <select id="query-object"><option value="">-- Select --</option></select>
                    </div>
                    <button class="btn success full mt-1" onclick="doQuerySubjects()">Show</button>
                    <div id="subjects-result"></div>
                </div>

                <div class="home-card" onclick="showQuery('delegation')">
                    <span class="hc-icon">üîó</span>
                    <span class="hc-name">Sharing Chain</span>
                </div>
                <div class="expand-section hidden" id="qf-delegation">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">Fill any combination to search</p>
                    <div class="form-row stack">
                        <div class="input-group">
                            <label>Who received?</label>
                            <select id="deleg-receiver"><option value="">Any</option></select>
                        </div>
                        <div class="input-group">
                            <label>On what?</label>
                            <select id="deleg-resource"><option value="">Any</option></select>
                        </div>
                        <div class="input-group">
                            <label>From who?</label>
                            <select id="deleg-source"><option value="">Any</option></select>
                        </div>
                    </div>
                    <button class="btn success full mt-1" onclick="doQueryDelegation()">Search</button>
                    <div id="delegation-result"></div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="tab-logs" class="tab-content">
            <div class="card">
                <div class="card-title">
                    Activity Log
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn sm outline" onclick="copyLogs()">Copy</button>
                        <button class="btn sm outline" onclick="clearLog()">Clear</button>
                    </div>
                </div>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab" id="fab" onclick="toggleModal()">+</button>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Create</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <!-- Action Menu (default view) -->
                <div id="modal-menu" class="action-menu">
                    <div class="menu-group-label">Create</div>
                    <button class="action-item" onclick="showForm('type')">
                        <span class="action-icon" style="background: rgba(139, 92, 246, 0.2);">T</span>
                        <div><strong>Type</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Define a new entity type</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('entity')">
                        <span class="action-icon entity">+</span>
                        <div><strong>Entity</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Add user, team, app, or resource</span></div>
                    </button>

                    <button class="action-item" onclick="showForm('cap-bit')">
                        <span class="action-icon cap">‚ö°</span>
                        <div><strong>Action</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Define what can be done</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('relation')">
                        <span class="action-icon cap">üë•</span>
                        <div><strong>Group</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Bundle actions together</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('grant')">
                        <span class="action-icon grant">üîë</span>
                        <div><strong>Member</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Add someone to a group</span></div>
                    </button>
                    <button class="action-item" onclick="showForm('delegate')">
                        <span class="action-icon delegate">üîó</span>
                        <div><strong>Sharing</strong><br><span style="color: var(--text-muted); font-size: 0.8rem;">Inherit from another</span></div>
                    </button>
                </div>

                <!-- Type Form -->
                <div id="form-type" class="hidden">
                    <div class="input-group">
                        <label>Type Name</label>
                        <input type="text" id="m-type-name" placeholder="e.g. project, document">
                    </div>
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Creates a new entity type. Requires TYPE_CREATE on _type:_type.
                    </p>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateTypeModal()">Create Type</button>
                </div>

                <!-- Entity Form -->
                <div id="form-entity" class="hidden">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Type</label>
                            <select id="m-entity-type">
                                <option value="user">user</option>
                                <option value="team">team</option>
                                <option value="app">app</option>
                                <option value="resource">resource</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ID</label>
                            <input type="text" id="m-entity-id" placeholder="e.g. alice">
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateEntityModal()">Create Entity</button>
                </div>

                <!-- Capability Bit Form -->
                <div id="form-cap-bit" class="hidden">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Entity Type</label>
                            <select id="m-label-scope" onchange="updateBitStatus()">
                                <option value="_type:resource">_type:resource</option>
                                <option value="_type:user">_type:user</option>
                                <option value="_type:team">_type:team</option>
                                <option value="_type:app">_type:app</option>
                                <option value="_type:_type">_type:_type</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Bit (0-15)</label>
                            <input type="number" id="m-label-bit" min="0" max="15" value="0" style="width: 70px;">
                        </div>
                    </div>
                    <div id="bit-status" style="margin-top: 0.5rem; font-size: 0.75rem;"></div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Label</label>
                        <input type="text" id="m-label-name" placeholder="e.g. read, write, enter">
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doDefineCapLabelModal()">Define Action</button>
                </div>

                <!-- Relation Form -->
                <div id="form-relation" class="hidden">
                    <div class="form-row">
                        <div class="input-group">
                            <label>Entity</label>
                            <select id="m-cap-scope" onchange="updateRelationDropdown(); updateCapBitLabels();">
                                <option value="">-- Select entity --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Relation</label>
                            <select id="m-cap-relation" onchange="handleRelationSelect()">
                                <option value="">-- Select entity first --</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group hidden" id="m-cap-new-relation-group" style="margin-top: 0.5rem;">
                        <label>New Relation Name</label>
                        <input type="text" id="m-cap-new-relation" placeholder="e.g. employee">
                    </div>
                    <div class="input-group" style="margin-top: 0.5rem;">
                        <label>Capability Bits</label>
                        <div id="m-cap-labels" style="display: flex; flex-direction: column; gap: 0.25rem; margin-top: 0.25rem;">
                            <span style="color: var(--text-muted); font-size: 0.8rem;">Select an entity to see available capability bits</span>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 0.5rem;">
                            <span style="font-family: monospace; font-size: 0.85rem;">Mask = <strong id="m-cap-value">0x0000</strong></span>
                            <button class="btn sm outline" type="button" onclick="showForm('cap-bit')">+ Define New Bit</button>
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateCapabilityModal()">Create Group</button>
                </div>

                <!-- Grant Form -->
                <div id="form-grant" class="hidden">
                    <div class="input-group">
                        <label>Who gets access?</label>
                        <select id="m-grant-seeker">
                            <option value="">-- Select person --</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <div class="input-group">
                            <label>To what?</label>
                            <select id="m-grant-scope" onchange="updateGrantRelationDropdown()">
                                <option value="">-- Select resource --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>As what group?</label>
                            <select id="m-grant-relation">
                                <option value="">-- Select resource first --</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateGrantModal()">Add Member</button>
                </div>

                <!-- Delegate Form -->
                <div id="form-delegate" class="hidden">
                    <div class="input-group">
                        <label>Who receives shared access?</label>
                        <select id="m-deleg-seeker">
                            <option value="">-- Select person --</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <div class="input-group">
                            <label>On what resource?</label>
                            <select id="m-deleg-scope">
                                <option value="">-- Select resource --</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>From who?</label>
                            <select id="m-deleg-source">
                                <option value="">-- Select person --</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn full" style="margin-top: 1rem;" onclick="doCreateDelegationModal()">Share</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
